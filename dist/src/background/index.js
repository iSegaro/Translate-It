(function(){"use strict";function tt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var ie={exports:{}},at=ie.exports,ye;function rt(){return ye||(ye=1,function(o,t){(function(a,r){r(o)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:at,function(a){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)a.exports=globalThis.browser;else{const r="The message port closed before a response was received.",i=e=>{const l={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(l).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class c extends WeakMap{constructor(h,b=void 0){super(b),this.createItem=h}get(h){return this.has(h)||this.set(h,this.createItem(h)),super.get(h)}}const g=p=>p&&typeof p=="object"&&typeof p.then=="function",A=(p,h)=>(...b)=>{e.runtime.lastError?p.reject(new Error(e.runtime.lastError.message)):h.singleCallbackArg||b.length<=1&&h.singleCallbackArg!==!1?p.resolve(b[0]):p.resolve(b)},m=p=>p==1?"argument":"arguments",n=(p,h)=>function(O,...G){if(G.length<h.minArgs)throw new Error(`Expected at least ${h.minArgs} ${m(h.minArgs)} for ${p}(), got ${G.length}`);if(G.length>h.maxArgs)throw new Error(`Expected at most ${h.maxArgs} ${m(h.maxArgs)} for ${p}(), got ${G.length}`);return new Promise((D,$)=>{if(h.fallbackToNoCallback)try{O[p](...G,A({resolve:D,reject:$},h))}catch(x){console.warn(`${p} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,x),O[p](...G),h.fallbackToNoCallback=!1,h.noCallback=!0,D()}else h.noCallback?(O[p](...G),D()):O[p](...G,A({resolve:D,reject:$},h))})},f=(p,h,b)=>new Proxy(h,{apply(O,G,D){return b.call(G,p,...D)}});let u=Function.call.bind(Object.prototype.hasOwnProperty);const C=(p,h={},b={})=>{let O=Object.create(null),G={has($,x){return x in p||x in O},get($,x,B){if(x in O)return O[x];if(!(x in p))return;let U=p[x];if(typeof U=="function")if(typeof h[x]=="function")U=f(p,p[x],h[x]);else if(u(b,x)){let y=n(x,b[x]);U=f(p,p[x],y)}else U=U.bind(p);else if(typeof U=="object"&&U!==null&&(u(h,x)||u(b,x)))U=C(U,h[x],b[x]);else if(u(b,"*"))U=C(U,h[x],b["*"]);else return Object.defineProperty(O,x,{configurable:!0,enumerable:!0,get(){return p[x]},set(y){p[x]=y}}),U;return O[x]=U,U},set($,x,B,U){return x in O?O[x]=B:p[x]=B,!0},defineProperty($,x,B){return Reflect.defineProperty(O,x,B)},deleteProperty($,x){return Reflect.deleteProperty(O,x)}},D=Object.create(p);return new Proxy(D,G)},v=p=>({addListener(h,b,...O){h.addListener(p.get(b),...O)},hasListener(h,b){return h.hasListener(p.get(b))},removeListener(h,b){h.removeListener(p.get(b))}}),T=new c(p=>typeof p!="function"?p:function(b){const O=C(b,{},{getContent:{minArgs:0,maxArgs:0}});p(O)}),E=new c(p=>typeof p!="function"?p:function(b,O,G){let D=!1,$,x=new Promise(L=>{$=function(N){D=!0,L(N)}}),B;try{B=p(b,O,$)}catch(L){B=Promise.reject(L)}const U=B!==!0&&g(B);if(B!==!0&&!U&&!D)return!1;const y=L=>{L.then(N=>{G(N)},N=>{let P;N&&(N instanceof Error||typeof N.message=="string")?P=N.message:P="An unexpected error occurred",G({__mozWebExtensionPolyfillReject__:!0,message:P})}).catch(N=>{console.error("Failed to send onMessage rejected reply",N)})};return y(U?B:x),!0}),_=({reject:p,resolve:h},b)=>{e.runtime.lastError?e.runtime.lastError.message===r?h():p(new Error(e.runtime.lastError.message)):b&&b.__mozWebExtensionPolyfillReject__?p(new Error(b.message)):h(b)},I=(p,h,b,...O)=>{if(O.length<h.minArgs)throw new Error(`Expected at least ${h.minArgs} ${m(h.minArgs)} for ${p}(), got ${O.length}`);if(O.length>h.maxArgs)throw new Error(`Expected at most ${h.maxArgs} ${m(h.maxArgs)} for ${p}(), got ${O.length}`);return new Promise((G,D)=>{const $=_.bind(null,{resolve:G,reject:D});O.push($),b.sendMessage(...O)})},R={devtools:{network:{onRequestFinished:v(T)}},runtime:{onMessage:v(E),onMessageExternal:v(E),sendMessage:I.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:I.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},S={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return l.privacy={network:{"*":S},services:{"*":S},websites:{"*":S}},C(e,R,l)};a.exports=i(chrome)}})}(ie)),ie.exports}var nt=rt();const F=tt(nt),w={APP_NAME:"Translate It",USE_MOCK:!1,DEBUG_MODE:!1,APPLICATION_LOCALIZE:"English",SOURCE_LANGUAGE:"English",TARGET_LANGUAGE:"Farsi",THEME:"auto",selectionTranslationMode:"onClick",COPY_REPLACE:"copy",REPLACE_SPECIAL_SITES:!0,CHANGELOG_URL:"https://raw.githubusercontent.com/iSegaro/Translate-It/main/Changelog.md",TRANSLATION_API:"google",API_URL:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",API_KEY:"",GEMINI_MODEL:"gemini-2.5-flash",GEMINI_THINKING_ENABLED:!0,GEMINI_MODELS:[{value:"gemini-2.5-pro",name:"Gemini 2.5 Pro",url:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent",thinking:{supported:!0,controllable:!1,defaultEnabled:!0}},{value:"gemini-2.5-flash",name:"Gemini 2.5 Flash",url:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",thinking:{supported:!0,controllable:!0,defaultEnabled:!0}},{value:"gemini-2.5-flash-lite-preview",name:"Gemini 2.5 Flash-Lite Preview",url:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite-preview-06-17:generateContent",thinking:{supported:!0,controllable:!0,defaultEnabled:!1}},{value:"gemini-2.0-flash",name:"Gemini 2.0 Flash",url:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",thinking:{supported:!1,controllable:!1,defaultEnabled:!1}},{value:"gemini-2.0-flash-lite",name:"Gemini 2.0 Flash-Lite",url:"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent",thinking:{supported:!1,controllable:!1,defaultEnabled:!1}},{value:"custom",name:"Custom URL",url:"",thinking:{supported:!1,controllable:!1,defaultEnabled:!1}}],GOOGLE_TRANSLATE_URL:"https://translate.googleapis.com/translate_a/single",WEBAI_API_URL:"http://localhost:6969/translate",WEBAI_API_MODEL:"gemini-2.0-flash",OPENAI_API_KEY:"",OPENAI_API_URL:"https://api.openai.com/v1/chat/completions",OPENAI_API_MODEL:"gpt-4o",OPENAI_MODELS:[{value:"gpt-4.1",name:"GPT-4.1"},{value:"gpt-4.1-mini",name:"GPT-4.1 Mini"},{value:"gpt-4.1-nano",name:"GPT-4.1 Nano"},{value:"gpt-4o",name:"GPT-4o"},{value:"gpt-4o-mini",name:"GPT-4o Mini"},{value:"gpt-4.5-preview",name:"GPT-4.5 Preview"},{value:"gpt-3.5-turbo",name:"GPT-3.5 Turbo"},{value:"custom",name:"Custom Model"}],OPENROUTER_API_KEY:"",OPENROUTER_API_URL:"https://openrouter.ai/api/v1/chat/completions",OPENROUTER_API_MODEL:"openai/gpt-4o",OPENROUTER_MODELS:[{value:"openai/gpt-4o",name:"OpenAI GPT-4o"},{value:"openai/gpt-4o-mini",name:"OpenAI GPT-4o Mini"},{value:"openai/gpt-4.1",name:"OpenAI GPT-4.1"},{value:"openai/gpt-4.1-mini",name:"OpenAI GPT-4.1 Mini"},{value:"anthropic/claude-3.5-sonnet",name:"Claude 3.5 Sonnet"},{value:"anthropic/claude-3.5-haiku",name:"Claude 3.5 Haiku"},{value:"google/gemini-2.5-pro",name:"Google Gemini 2.5 Pro"},{value:"google/gemini-2.5-flash",name:"Google Gemini 2.5 Flash"},{value:"meta-llama/llama-3.3-70b-instruct",name:"Meta Llama 3.3 70B"},{value:"mistralai/mistral-large",name:"Mistral Large"},{value:"custom",name:"Custom Model"}],DEEPSEEK_API_KEY:"",DEEPSEEK_API_URL:"https://api.deepseek.com/chat/completions",DEEPSEEK_API_MODEL:"deepseek-chat",DEEPSEEK_MODELS:[{value:"deepseek-chat",name:"DeepSeek Chat (V3)"},{value:"deepseek-reasoner",name:"DeepSeek Reasoner (R1)"},{value:"custom",name:"Custom Model"}],CUSTOM_API_URL:"",CUSTOM_API_KEY:"",CUSTOM_API_MODEL:"",BROWSER_TRANSLATE_ENABLED:!0,BROWSER_TRANSLATE_AUTO_DOWNLOAD:!0,EXTENSION_ENABLED:!0,TRANSLATE_ON_TEXT_FIELDS:!1,ENABLE_SHORTCUT_FOR_TEXT_FIELDS:!0,TRANSLATE_WITH_SELECT_ELEMENT:!0,TRANSLATE_ON_TEXT_SELECTION:!0,REQUIRE_CTRL_FOR_TEXT_SELECTION:!1,ENABLE_DICTIONARY:!0,ENABLE_SUBTITLE_TRANSLATION:!1,SHOW_SUBTITLE_ICON:!0,ENABLE_SCREEN_CAPTURE:!0,HIGHTLIH_NEW_ELEMENT_RED:"2px solid red",TRANSLATION_ICON_TITLE:"Translate Text",HIGHLIGHT_STYLE:"2px solid red",ICON_TRANSLATION:"ðŸŒ",ICON_SUCCESS:"âœ… ",ICON_WARNING:"âš ï¸ ",ICON_STATUS:"â³ ",ICON_ERROR:"âŒ ",ICON_INFO:"ðŸ”µ ",ICON_REVERT:"â†©ï¸",NOTIFICATION_ALIGNMENT:"right",NOTIFICATION_TEXT_DIRECTION:"rtl",NOTIFICATION_TEXT_ALIGNMENT:"right",RTL_REGEX:/[\u0591-\u07FF\u0600-\u06FF]/,PERSIAN_REGEX:/^(?=.*[\u0600-\u06FF])[\u0600-\u06FF\u0660-\u0669\u06F0-\u06F9\u0041-\u005A\u0061-\u007A\u0030-\u0039\s.,:;ØŸ!()Â«Â»@#\n\t\u200C]+$/,PROMPT_BASE_FIELD:`You are a professional translation service. Your task is to accurately and fluently translate text between $_{SOURCE} and $_{TARGET}, or from any other language into $_{TARGET}, depending on the input.

Strictly follow these instructions:

- Detect the input language.
- If the input is in $_{SOURCE}, translate it into $_{TARGET}.
- If the input is in $_{TARGET}, translate it into $_{SOURCE}.
- If the input is in any other language, translate it into $_{TARGET}.
- If the input is grammatically incorrect but written in $_{TARGET}, translate it into $_{SOURCE}, preserving the intended meaning.

Translation quality requirements:
- Produce fluent, natural, and idiomatic translations as if written by a native speaker.
- Prioritize clarity, tone, and readability over literal or word-for-word translation.
- Maintain the original formatting, structure, and line breaks exactly.
- Do **not** include any additional explanations, comments, markdown, or extra content.

Output only the translated text:

$_{TEXT}
`,PROMPT_BASE_SELECT:`Act as a fluent and natural JSON translation service. The input is a JSON array where each object contains a "text" property.

Your task:
  1. Translate each "text" value according to the following user rules: $_{USER_RULES}
  2. Preserve all fields. **Do not omit, modify, or skip any entries.**
  3. If translation is unnecessary (e.g., for numbers, hashtags, URLs), **return the original value unchanged.**
  4. Retain exact formatting, structure, and line breaks.
  5. Ensure translations are fluent, idiomatic, and natural â€” not literal or robotic.
  6. Prioritize meaning and readability over strict word-for-word translation.

Return **only** the translated JSON array. Do not include explanations, markdown, or any extra content.

$_{TEXT}
`,PROMPT_BASE_DICTIONARY:`You are a concise dictionary service. Translate the word/phrase into $_{TARGET} and provide only essential information.

Format your response as:
- Main translation
- Part of speech (if relevant): noun, verb, adjective, etc.
- 2-3 most common synonyms or alternative meanings (if any)

Keep it brief and useful. Do not include examples, long definitions, or explanations.

$_{TEXT}
`,PROMPT_BASE_POPUP_TRANSLATE:`You are a translation service. Your task is to translate the input text into $_{TARGET}, while strictly preserving its structure, formatting, and line breaks.

Instructions:
  - Automatically detect the input language.
  - Translate the content into $_{TARGET}.
  - Ensure that the translation is fluent, natural, and idiomatic â€” not literal or mechanical.
  - Prioritize clarity, smooth flow, and accurate meaning, without changing the original structure or layout.

Return **only** the translated text. Do not include explanations, markdown, or any other content.

$_{TEXT}
`,PROMPT_BASE_SUBTITLE:`You are a professional subtitle translation service specializing in video content translation. Your task is to translate subtitle text from any detected language into $_{TARGET} while maintaining optimal readability for video viewers.

**Context**: This is a subtitle/caption from a video that appears on screen for a brief moment while the viewer is watching.

**Translation Guidelines**:
- Detect the input language automatically
- Translate into $_{TARGET} with natural, fluent expression
- Prioritize **conciseness** and **readability** - subtitles must be quickly readable
- Maintain the **original meaning and tone** (formal, casual, emotional, etc.)
- Preserve **timing-sensitive** expressions (exclamations, questions, emphasis)
- Use **conversational language** appropriate for spoken dialogue
- For technical terms, use commonly understood equivalents
- Keep **cultural context** - adapt idioms and references when necessary
- **Remove redundancy** - make text as clear and concise as possible

**Critical Requirements**:
- Output **ONLY** the translated text
- Do **NOT** add explanations, notes, markdown, or formatting
- Do **NOT** include quotation marks or additional punctuation
- Ensure the translation sounds **natural when spoken**
- Make it easily readable in **2-4 seconds** (typical subtitle display time)

**Input text to translate**:

$_{TEXT}`,PROMPT_BASE_SCREEN_CAPTURE:`You are a professional image text extraction and translation service. Your task is to extract all readable text from the provided image and translate it into $_{TARGET}.

**Your responsibilities:**
1. **Extract ALL visible text** from the image, including:
   - Main text content, titles, headers, and paragraphs
   - UI elements, buttons, labels, and menu items
   - Captions, annotations, and overlaid text
   - Signs, logos, and watermarks with readable text
   - Any other textual information visible in the image

2. **Translation Guidelines:**
   - Automatically detect the language of extracted text
   - Translate all extracted text into $_{TARGET}
   - Maintain **natural, fluent, and idiomatic** translations
   - Preserve the **original meaning and context**
   - Use **appropriate terminology** for the content type (technical, casual, formal, etc.)
   - Keep **spatial relationships** when multiple text elements exist

3. **Output Format:**
   - If the image contains **single text block**: Output only the translated text
   - If the image contains **multiple separate text elements**: Use clear formatting to distinguish between different text areas
   - **DO NOT** include explanations, descriptions, or metadata about the image
   - **DO NOT** describe non-text visual elements (colors, layout, graphics, etc.)

4. **Quality Requirements:**
   - Ensure **accuracy** in text extraction - don't miss any readable text
   - Provide **high-quality translations** that sound natural in $_{TARGET}
   - Maintain **consistency** in terminology throughout the translation
   - Handle **special characters, numbers, and symbols** appropriately

**Important:** Output ONLY the translated text content. Do not include any analysis, descriptions, or additional commentary.`,PROMPT_TEMPLATE:`- If the input is in $_{SOURCE}, translate it into $_{TARGET} using fluent and natural language, while preserving the original intent.
- If the input is in $_{TARGET}, translate it into $_{SOURCE} with the same level of fluency and clarity.
- If the input is in any other language, translate it into $_{TARGET}, focusing on readability, tone, and meaning rather than literal translation.
- If the input contains grammatical errors but is in $_{TARGET}, translate it into $_{SOURCE}, correcting and expressing the intended meaning in a clear, natural way.`,DEBUG_TRANSLATED_ENGLISH:"This is a mock translation to English.",DEBUG_TRANSLATED_PERSIAN:"Ø§ÛŒÙ† ÛŒÚ© ØªØ±Ø¬Ù…Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø§Ø³Øª.",DEBUG_TRANSLATED_ENGLISH_With_NewLine:`This is a mock 
translation to English with 
new lines.`,DEBUG_TRANSLATED_PERSIAN_With_NewLine:`Ø§ÛŒÙ† ÛŒÚ© ØªØ±Ø¬Ù…Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ 
Ø¨Ø±Ø§ÛŒ ØªØ±Ø¬Ù…Ù‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ 
Ø¨Ø§ Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª.`},V={Field:"field",Dictionary_Translation:"dictionary",Popup_Translate:"popup_translate",Sidepanel_Translate:"sidepanel_translate",Subtitle:"subtitle"};let K=null;const it=async()=>K!==null?K:F.storage.local.get(null).then(o=>(K={...w,...o},K)).catch(o=>(d("Error fetching settings:",o),K={...w},K));F&&F.storage&&F.storage.onChanged?F.storage.onChanged.addListener((o,t)=>{t==="local"&&K&&Object.keys(o).forEach(a=>{if(Object.prototype.hasOwnProperty.call(w,a)||K&&Object.prototype.hasOwnProperty.call(K,a)){const r=o[a].newValue;K[a]!==r&&(K[a]=r)}})}):d("Browser.storage.onChanged not available. Settings cache might become stale.");const k=async(o,t)=>(await it())?.[o]??t,ve=async()=>k("DEBUG_MODE",w.DEBUG_MODE),st=async()=>K&&K.DEBUG_MODE!==void 0?K.DEBUG_MODE:ve(),Ce=async()=>k("API_KEY",w.API_KEY),be=async()=>k("API_URL",w.API_URL),we=async()=>k("GEMINI_MODEL",w.GEMINI_MODEL),ot=async()=>k("GEMINI_THINKING_ENABLED",w.GEMINI_THINKING_ENABLED),lt=async()=>k("GOOGLE_TRANSLATE_URL",w.GOOGLE_TRANSLATE_URL),ct=async()=>k("APPLICATION_LOCALIZE",w.APPLICATION_LOCALIZE),xe=async()=>k("ENABLE_DICTIONARY",w.ENABLE_DICTIONARY),ut=async()=>k("PROMPT_TEMPLATE",w.PROMPT_TEMPLATE),gt=async()=>k("PROMPT_BASE_DICTIONARY",w.PROMPT_BASE_DICTIONARY),dt=async()=>k("PROMPT_BASE_POPUP_TRANSLATE",w.PROMPT_BASE_POPUP_TRANSLATE),mt=async()=>k("PROMPT_BASE_SELECT",w.PROMPT_BASE_SELECT),Se=async()=>k("PROMPT_BASE_FIELD",w.PROMPT_BASE_FIELD),pt=async()=>k("PROMPT_BASE_SUBTITLE",w.PROMPT_BASE_SUBTITLE),Re=async()=>k("PROMPT_BASE_SCREEN_CAPTURE",w.PROMPT_BASE_SCREEN_CAPTURE),ft=async()=>k("WEBAI_API_URL",w.WEBAI_API_URL),ht=async()=>k("WEBAI_API_MODEL",w.WEBAI_API_MODEL),At=async()=>k("DEEPSEEK_API_KEY",w.DEEPSEEK_API_KEY),Et=async()=>k("DEEPSEEK_API_MODEL",w.DEEPSEEK_API_MODEL),Tt=async()=>k("CUSTOM_API_URL",w.CUSTOM_API_URL),_t=async()=>k("CUSTOM_API_KEY",w.CUSTOM_API_KEY),It=async()=>k("CUSTOM_API_MODEL",w.CUSTOM_API_MODEL),Oe=async()=>k("OPENAI_API_KEY",w.OPENAI_API_KEY),Pe=async()=>w.OPENAI_API_URL,Le=async()=>k("OPENAI_API_MODEL",w.OPENAI_API_MODEL),Nt=async()=>k("OPENROUTER_API_KEY",w.OPENROUTER_API_KEY),yt=async()=>k("OPENROUTER_API_MODEL",w.OPENROUTER_API_MODEL),vt=[{name:"English",voiceCode:"en-US",promptName:"English",code:"en",locale:"en",flagCode:"gb"},{name:"Farsi",voiceCode:"fa-IR",promptName:"Farsi",code:"fa",locale:"fa",flagCode:"ir"},{name:"German",voiceCode:"de-DE",promptName:"German",code:"de"},{name:"French",voiceCode:"fr-FR",promptName:"French",code:"fr"},{name:"Chinese (Simplified)",voiceCode:"zh-CN",promptName:"Chinese (Simplified)",code:"zh"},{name:"Spanish",voiceCode:"es-ES",promptName:"Spanish",code:"es"},{name:"Hindi",voiceCode:"hi-IN",promptName:"Hindi",code:"hi"},{name:"Arabic",voiceCode:"ar-SA",promptName:"Arabic",code:"ar"},{name:"Bengali",voiceCode:"bn-BD",promptName:"Bengali",code:"bn"},{name:"Portuguese",voiceCode:"pt-PT",promptName:"Portuguese",code:"pt"},{name:"Russian",voiceCode:"ru-RU",promptName:"Russian",code:"ru"},{name:"Japanese",voiceCode:"ja-JP",promptName:"Japanese",code:"ja"},{name:"Urdu",voiceCode:"ur-PK",promptName:"Urdu",code:"ur"},{name:"Indonesian",voiceCode:"id-ID",promptName:"Indonesian",code:"id"},{name:"Italian",voiceCode:"it-IT",promptName:"Italian",code:"it"},{name:"Swahili",voiceCode:"sw-KE",promptName:"Swahili",code:"sw"},{name:"Marathi",voiceCode:"mr-IN",promptName:"Marathi",code:"mr"},{name:"Telugu",voiceCode:"te-IN",promptName:"Telugu",code:"te"},{name:"Tamil",voiceCode:"ta-IN",promptName:"Tamil",code:"ta"},{name:"Turkish",voiceCode:"tr-TR",promptName:"Turkish",code:"tr"},{name:"Vietnamese",voiceCode:"vi-VN",promptName:"Vietnamese",code:"vi"},{name:"Korean",voiceCode:"ko-KR",promptName:"Korean",code:"ko"},{name:"Thai",voiceCode:"th-TH",promptName:"Thai",code:"th"},{name:"Malay",voiceCode:"ms-MY",promptName:"Malay",code:"ms"},{name:"Polish",voiceCode:"pl-PL",promptName:"Polish",code:"pl"},{name:"Dutch",voiceCode:"nl-NL",promptName:"Dutch",code:"nl"},{name:"Filipino",voiceCode:"fil-PH",promptName:"Filipino",code:"fi"},{name:"Ukrainian",voiceCode:"uk-UA",promptName:"Ukrainian",code:"uk"},{name:"Romanian",voiceCode:"ro-RO",promptName:"Romanian",code:"ro"},{name:"Greek",voiceCode:"el-GR",promptName:"Greek",code:"el"},{name:"Czech",voiceCode:"cs-CZ",promptName:"Czech",code:"cs"},{name:"Hungarian",voiceCode:"hu-HU",promptName:"Hungarian",code:"hu"},{name:"Swedish",voiceCode:"sv-SE",promptName:"Swedish",code:"sv"},{name:"Norwegian",voiceCode:"no-NO",promptName:"Norwegian",code:"no"},{name:"Danish",voiceCode:"da-DK",promptName:"Danish",code:"da"},{name:"Finnish",voiceCode:"fi-FI",promptName:"Finnish",code:"fi"},{name:"Hebrew",voiceCode:"he-IL",promptName:"Hebrew",code:"he"},{name:"Afrikaans",voiceCode:"af-ZA",promptName:"Afrikaans",code:"af"},{name:"Albanian",voiceCode:"sq-AL",promptName:"Albanian",code:"sq"},{name:"Bulgarian",voiceCode:"bg-BG",promptName:"Bulgarian",code:"bg"},{name:"Catalan",voiceCode:"ca-ES",promptName:"Catalan",code:"ca"},{name:"Croatian",voiceCode:"hr-HR",promptName:"Croatian",code:"hr"},{name:"Estonian",voiceCode:"et-EE",promptName:"Estonian",code:"et"},{name:"Latvian",voiceCode:"lv-LV",promptName:"Latvian",code:"lv"},{name:"Lithuanian",voiceCode:"lt-LT",promptName:"Lithuanian",code:"lt"},{name:"Slovak",voiceCode:"sk-SK",promptName:"Slovak",code:"sk"},{name:"Slovenian",voiceCode:"sl-SI",promptName:"Slovenian",code:"sl"},{name:"Serbian",voiceCode:"sr-RS",promptName:"Serbian",code:"sr"},{name:"Malayalam",voiceCode:"ml-IN",promptName:"Malayalam",code:"ml"},{name:"Kannada",voiceCode:"kn-IN",promptName:"Kannada",code:"kn"},{name:"Odia",voiceCode:"or-IN",promptName:"Odia",code:"or"},{name:"Punjabi",voiceCode:"pa-IN",promptName:"Punjabi",code:"pa"},{name:"Sinhala",voiceCode:"si-LK",promptName:"Sinhala",code:"si"},{name:"Nepali",voiceCode:"ne-NP",promptName:"Nepali",code:"ne"},{name:"Azerbaijani",voiceCode:"az-AZ",promptName:"Azerbaijani",code:"az"},{name:"Belarusian",voiceCode:"be-BY",promptName:"Belarusian",code:"be"},{name:"Kazakh",voiceCode:"kk-KZ",promptName:"Kazakh",code:"kk"},{name:"Uzbek",voiceCode:"uz-UZ",promptName:"Uzbek",code:"uz"},{name:"Pashto",voiceCode:"ps-AF",promptName:"Pashto",code:"ps"},{name:"Tagalog",voiceCode:"tl-PH",promptName:"Tagalog",code:"tl"},{name:"Cebuano",voiceCode:"en-US",promptName:"Cebuano",code:"en"}],J=o=>w.PERSIAN_REGEX.test(o);var se={exports:{}},M={},oe={exports:{}},Q={},ke;function De(){if(ke)return Q;ke=1;function o(){var e={};return e["align-content"]=!1,e["align-items"]=!1,e["align-self"]=!1,e["alignment-adjust"]=!1,e["alignment-baseline"]=!1,e.all=!1,e["anchor-point"]=!1,e.animation=!1,e["animation-delay"]=!1,e["animation-direction"]=!1,e["animation-duration"]=!1,e["animation-fill-mode"]=!1,e["animation-iteration-count"]=!1,e["animation-name"]=!1,e["animation-play-state"]=!1,e["animation-timing-function"]=!1,e.azimuth=!1,e["backface-visibility"]=!1,e.background=!0,e["background-attachment"]=!0,e["background-clip"]=!0,e["background-color"]=!0,e["background-image"]=!0,e["background-origin"]=!0,e["background-position"]=!0,e["background-repeat"]=!0,e["background-size"]=!0,e["baseline-shift"]=!1,e.binding=!1,e.bleed=!1,e["bookmark-label"]=!1,e["bookmark-level"]=!1,e["bookmark-state"]=!1,e.border=!0,e["border-bottom"]=!0,e["border-bottom-color"]=!0,e["border-bottom-left-radius"]=!0,e["border-bottom-right-radius"]=!0,e["border-bottom-style"]=!0,e["border-bottom-width"]=!0,e["border-collapse"]=!0,e["border-color"]=!0,e["border-image"]=!0,e["border-image-outset"]=!0,e["border-image-repeat"]=!0,e["border-image-slice"]=!0,e["border-image-source"]=!0,e["border-image-width"]=!0,e["border-left"]=!0,e["border-left-color"]=!0,e["border-left-style"]=!0,e["border-left-width"]=!0,e["border-radius"]=!0,e["border-right"]=!0,e["border-right-color"]=!0,e["border-right-style"]=!0,e["border-right-width"]=!0,e["border-spacing"]=!0,e["border-style"]=!0,e["border-top"]=!0,e["border-top-color"]=!0,e["border-top-left-radius"]=!0,e["border-top-right-radius"]=!0,e["border-top-style"]=!0,e["border-top-width"]=!0,e["border-width"]=!0,e.bottom=!1,e["box-decoration-break"]=!0,e["box-shadow"]=!0,e["box-sizing"]=!0,e["box-snap"]=!0,e["box-suppress"]=!0,e["break-after"]=!0,e["break-before"]=!0,e["break-inside"]=!0,e["caption-side"]=!1,e.chains=!1,e.clear=!0,e.clip=!1,e["clip-path"]=!1,e["clip-rule"]=!1,e.color=!0,e["color-interpolation-filters"]=!0,e["column-count"]=!1,e["column-fill"]=!1,e["column-gap"]=!1,e["column-rule"]=!1,e["column-rule-color"]=!1,e["column-rule-style"]=!1,e["column-rule-width"]=!1,e["column-span"]=!1,e["column-width"]=!1,e.columns=!1,e.contain=!1,e.content=!1,e["counter-increment"]=!1,e["counter-reset"]=!1,e["counter-set"]=!1,e.crop=!1,e.cue=!1,e["cue-after"]=!1,e["cue-before"]=!1,e.cursor=!1,e.direction=!1,e.display=!0,e["display-inside"]=!0,e["display-list"]=!0,e["display-outside"]=!0,e["dominant-baseline"]=!1,e.elevation=!1,e["empty-cells"]=!1,e.filter=!1,e.flex=!1,e["flex-basis"]=!1,e["flex-direction"]=!1,e["flex-flow"]=!1,e["flex-grow"]=!1,e["flex-shrink"]=!1,e["flex-wrap"]=!1,e.float=!1,e["float-offset"]=!1,e["flood-color"]=!1,e["flood-opacity"]=!1,e["flow-from"]=!1,e["flow-into"]=!1,e.font=!0,e["font-family"]=!0,e["font-feature-settings"]=!0,e["font-kerning"]=!0,e["font-language-override"]=!0,e["font-size"]=!0,e["font-size-adjust"]=!0,e["font-stretch"]=!0,e["font-style"]=!0,e["font-synthesis"]=!0,e["font-variant"]=!0,e["font-variant-alternates"]=!0,e["font-variant-caps"]=!0,e["font-variant-east-asian"]=!0,e["font-variant-ligatures"]=!0,e["font-variant-numeric"]=!0,e["font-variant-position"]=!0,e["font-weight"]=!0,e.grid=!1,e["grid-area"]=!1,e["grid-auto-columns"]=!1,e["grid-auto-flow"]=!1,e["grid-auto-rows"]=!1,e["grid-column"]=!1,e["grid-column-end"]=!1,e["grid-column-start"]=!1,e["grid-row"]=!1,e["grid-row-end"]=!1,e["grid-row-start"]=!1,e["grid-template"]=!1,e["grid-template-areas"]=!1,e["grid-template-columns"]=!1,e["grid-template-rows"]=!1,e["hanging-punctuation"]=!1,e.height=!0,e.hyphens=!1,e.icon=!1,e["image-orientation"]=!1,e["image-resolution"]=!1,e["ime-mode"]=!1,e["initial-letters"]=!1,e["inline-box-align"]=!1,e["justify-content"]=!1,e["justify-items"]=!1,e["justify-self"]=!1,e.left=!1,e["letter-spacing"]=!0,e["lighting-color"]=!0,e["line-box-contain"]=!1,e["line-break"]=!1,e["line-grid"]=!1,e["line-height"]=!1,e["line-snap"]=!1,e["line-stacking"]=!1,e["line-stacking-ruby"]=!1,e["line-stacking-shift"]=!1,e["line-stacking-strategy"]=!1,e["list-style"]=!0,e["list-style-image"]=!0,e["list-style-position"]=!0,e["list-style-type"]=!0,e.margin=!0,e["margin-bottom"]=!0,e["margin-left"]=!0,e["margin-right"]=!0,e["margin-top"]=!0,e["marker-offset"]=!1,e["marker-side"]=!1,e.marks=!1,e.mask=!1,e["mask-box"]=!1,e["mask-box-outset"]=!1,e["mask-box-repeat"]=!1,e["mask-box-slice"]=!1,e["mask-box-source"]=!1,e["mask-box-width"]=!1,e["mask-clip"]=!1,e["mask-image"]=!1,e["mask-origin"]=!1,e["mask-position"]=!1,e["mask-repeat"]=!1,e["mask-size"]=!1,e["mask-source-type"]=!1,e["mask-type"]=!1,e["max-height"]=!0,e["max-lines"]=!1,e["max-width"]=!0,e["min-height"]=!0,e["min-width"]=!0,e["move-to"]=!1,e["nav-down"]=!1,e["nav-index"]=!1,e["nav-left"]=!1,e["nav-right"]=!1,e["nav-up"]=!1,e["object-fit"]=!1,e["object-position"]=!1,e.opacity=!1,e.order=!1,e.orphans=!1,e.outline=!1,e["outline-color"]=!1,e["outline-offset"]=!1,e["outline-style"]=!1,e["outline-width"]=!1,e.overflow=!1,e["overflow-wrap"]=!1,e["overflow-x"]=!1,e["overflow-y"]=!1,e.padding=!0,e["padding-bottom"]=!0,e["padding-left"]=!0,e["padding-right"]=!0,e["padding-top"]=!0,e.page=!1,e["page-break-after"]=!1,e["page-break-before"]=!1,e["page-break-inside"]=!1,e["page-policy"]=!1,e.pause=!1,e["pause-after"]=!1,e["pause-before"]=!1,e.perspective=!1,e["perspective-origin"]=!1,e.pitch=!1,e["pitch-range"]=!1,e["play-during"]=!1,e.position=!1,e["presentation-level"]=!1,e.quotes=!1,e["region-fragment"]=!1,e.resize=!1,e.rest=!1,e["rest-after"]=!1,e["rest-before"]=!1,e.richness=!1,e.right=!1,e.rotation=!1,e["rotation-point"]=!1,e["ruby-align"]=!1,e["ruby-merge"]=!1,e["ruby-position"]=!1,e["shape-image-threshold"]=!1,e["shape-outside"]=!1,e["shape-margin"]=!1,e.size=!1,e.speak=!1,e["speak-as"]=!1,e["speak-header"]=!1,e["speak-numeral"]=!1,e["speak-punctuation"]=!1,e["speech-rate"]=!1,e.stress=!1,e["string-set"]=!1,e["tab-size"]=!1,e["table-layout"]=!1,e["text-align"]=!0,e["text-align-last"]=!0,e["text-combine-upright"]=!0,e["text-decoration"]=!0,e["text-decoration-color"]=!0,e["text-decoration-line"]=!0,e["text-decoration-skip"]=!0,e["text-decoration-style"]=!0,e["text-emphasis"]=!0,e["text-emphasis-color"]=!0,e["text-emphasis-position"]=!0,e["text-emphasis-style"]=!0,e["text-height"]=!0,e["text-indent"]=!0,e["text-justify"]=!0,e["text-orientation"]=!0,e["text-overflow"]=!0,e["text-shadow"]=!0,e["text-space-collapse"]=!0,e["text-transform"]=!0,e["text-underline-position"]=!0,e["text-wrap"]=!0,e.top=!1,e.transform=!1,e["transform-origin"]=!1,e["transform-style"]=!1,e.transition=!1,e["transition-delay"]=!1,e["transition-duration"]=!1,e["transition-property"]=!1,e["transition-timing-function"]=!1,e["unicode-bidi"]=!1,e["vertical-align"]=!1,e.visibility=!1,e["voice-balance"]=!1,e["voice-duration"]=!1,e["voice-family"]=!1,e["voice-pitch"]=!1,e["voice-range"]=!1,e["voice-rate"]=!1,e["voice-stress"]=!1,e["voice-volume"]=!1,e.volume=!1,e["white-space"]=!1,e.widows=!1,e.width=!0,e["will-change"]=!1,e["word-break"]=!0,e["word-spacing"]=!0,e["word-wrap"]=!0,e["wrap-flow"]=!1,e["wrap-through"]=!1,e["writing-mode"]=!1,e["z-index"]=!1,e}function t(e,l,c){}function a(e,l,c){}var r=/javascript\s*\:/img;function i(e,l){return r.test(l)?"":l}return Q.whiteList=o(),Q.getDefaultWhiteList=o,Q.onAttr=t,Q.onIgnoreAttr=a,Q.safeAttrValue=i,Q}var ce,Ue;function Me(){return Ue||(Ue=1,ce={indexOf:function(o,t){var a,r;if(Array.prototype.indexOf)return o.indexOf(t);for(a=0,r=o.length;a<r;a++)if(o[a]===t)return a;return-1},forEach:function(o,t,a){var r,i;if(Array.prototype.forEach)return o.forEach(t,a);for(r=0,i=o.length;r<i;r++)t.call(a,o[r],r,o)},trim:function(o){return String.prototype.trim?o.trim():o.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(o){return String.prototype.trimRight?o.trimRight():o.replace(/(\s*$)/g,"")}}),ce}var ue,$e;function Ct(){if($e)return ue;$e=1;var o=Me();function t(a,r){a=o.trimRight(a),a[a.length-1]!==";"&&(a+=";");var i=a.length,e=!1,l=0,c=0,g="";function A(){if(!e){var f=o.trim(a.slice(l,c)),u=f.indexOf(":");if(u!==-1){var C=o.trim(f.slice(0,u)),v=o.trim(f.slice(u+1));if(C){var T=r(l,g.length,C,v,f);T&&(g+=T+"; ")}}}l=c+1}for(;c<i;c++){var m=a[c];if(m==="/"&&a[c+1]==="*"){var n=a.indexOf("*/",c+2);if(n===-1)break;c=n+1,l=c+1,e=!1}else m==="("?e=!0:m===")"?e=!1:m===";"?e||A():m===`
`&&A()}return o.trim(g)}return ue=t,ue}var ge,Ge;function bt(){if(Ge)return ge;Ge=1;var o=De(),t=Ct();Me();function a(e){return e==null}function r(e){var l={};for(var c in e)l[c]=e[c];return l}function i(e){e=r(e||{}),e.whiteList=e.whiteList||o.whiteList,e.onAttr=e.onAttr||o.onAttr,e.onIgnoreAttr=e.onIgnoreAttr||o.onIgnoreAttr,e.safeAttrValue=e.safeAttrValue||o.safeAttrValue,this.options=e}return i.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var l=this,c=l.options,g=c.whiteList,A=c.onAttr,m=c.onIgnoreAttr,n=c.safeAttrValue,f=t(e,function(u,C,v,T,E){var _=g[v],I=!1;if(_===!0?I=_:typeof _=="function"?I=_(T):_ instanceof RegExp&&(I=_.test(T)),I!==!0&&(I=!1),T=n(v,T),!!T){var R={position:C,sourcePosition:u,source:E,isWhite:I};if(I){var S=A(v,T,R);return a(S)?v+":"+T:S}else{var S=m(v,T,R);if(!a(S))return S}}});return f},ge=i,ge}var Fe;function de(){return Fe||(Fe=1,function(o,t){var a=De(),r=bt();function i(l,c){var g=new r(c);return g.process(l)}t=o.exports=i,t.FilterCSS=r;for(var e in a)t[e]=a[e];typeof window<"u"&&(window.filterCSS=o.exports)}(oe,oe.exports)),oe.exports}var me,Be;function pe(){return Be||(Be=1,me={indexOf:function(o,t){var a,r;if(Array.prototype.indexOf)return o.indexOf(t);for(a=0,r=o.length;a<r;a++)if(o[a]===t)return a;return-1},forEach:function(o,t,a){var r,i;if(Array.prototype.forEach)return o.forEach(t,a);for(r=0,i=o.length;r<i;r++)t.call(a,o[r],r,o)},trim:function(o){return String.prototype.trim?o.trim():o.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(o){var t=/\s|\n|\t/,a=t.exec(o);return a?a.index:-1}}),me}var Ve;function Ke(){if(Ve)return M;Ve=1;var o=de().FilterCSS,t=de().getDefaultWhiteList,a=pe();function r(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height","loading"],ins:["datetime"],kbd:[],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var i=new o;function e(y,L,N){}function l(y,L,N){}function c(y,L,N){}function g(y,L,N){}function A(y){return y.replace(n,"&lt;").replace(f,"&gt;")}function m(y,L,N,P){if(N=G(N),L==="href"||L==="src"){if(N=a.trim(N),N==="#")return"#";if(!(N.substr(0,7)==="http://"||N.substr(0,8)==="https://"||N.substr(0,7)==="mailto:"||N.substr(0,4)==="tel:"||N.substr(0,11)==="data:image/"||N.substr(0,6)==="ftp://"||N.substr(0,2)==="./"||N.substr(0,3)==="../"||N[0]==="#"||N[0]==="/"))return""}else if(L==="background"){if(_.lastIndex=0,_.test(N))return""}else if(L==="style"){if(I.lastIndex=0,I.test(N)||(R.lastIndex=0,R.test(N)&&(_.lastIndex=0,_.test(N))))return"";P!==!1&&(P=P||i,N=P.process(N))}return N=D(N),N}var n=/</g,f=/>/g,u=/"/g,C=/&quot;/g,v=/&#([a-zA-Z0-9]*);?/gim,T=/&colon;?/gim,E=/&newline;?/gim,_=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,I=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,R=/u\s*r\s*l\s*\(.*/gi;function S(y){return y.replace(u,"&quot;")}function p(y){return y.replace(C,'"')}function h(y){return y.replace(v,function(N,P){return P[0]==="x"||P[0]==="X"?String.fromCharCode(parseInt(P.substr(1),16)):String.fromCharCode(parseInt(P,10))})}function b(y){return y.replace(T,":").replace(E," ")}function O(y){for(var L="",N=0,P=y.length;N<P;N++)L+=y.charCodeAt(N)<32?" ":y.charAt(N);return a.trim(L)}function G(y){return y=p(y),y=h(y),y=b(y),y=O(y),y}function D(y){return y=S(y),y=A(y),y}function $(){return""}function x(y,L){typeof L!="function"&&(L=function(){});var N=!Array.isArray(y);function P(W){return N?!0:a.indexOf(y,W)!==-1}var z=[],j=!1;return{onIgnoreTag:function(W,re,Y){if(P(W))if(Y.isClosing){var ne="[/removed]",aa=Y.position+ne.length;return z.push([j!==!1?j:Y.position,aa]),j=!1,ne}else return j||(j=Y.position),"[removed]";else return L(W,re,Y)},remove:function(W){var re="",Y=0;return a.forEach(z,function(ne){re+=W.slice(Y,ne[0]),Y=ne[1]}),re+=W.slice(Y),re}}}function B(y){for(var L="",N=0;N<y.length;){var P=y.indexOf("<!--",N);if(P===-1){L+=y.slice(N);break}L+=y.slice(N,P);var z=y.indexOf("-->",P);if(z===-1)break;N=z+3}return L}function U(y){var L=y.split("");return L=L.filter(function(N){var P=N.charCodeAt(0);return P===127?!1:P<=31?P===10||P===13:!0}),L.join("")}return M.whiteList=r(),M.getDefaultWhiteList=r,M.onTag=e,M.onIgnoreTag=l,M.onTagAttr=c,M.onIgnoreTagAttr=g,M.safeAttrValue=m,M.escapeHtml=A,M.escapeQuote=S,M.unescapeQuote=p,M.escapeHtmlEntities=h,M.escapeDangerHtml5Entities=b,M.clearNonPrintableCharacter=O,M.friendlyAttrValue=G,M.escapeAttrValue=D,M.onIgnoreTagStripAll=$,M.StripTagBody=x,M.stripCommentTag=B,M.stripBlankChar=U,M.attributeWrapSign='"',M.cssFilter=i,M.getDefaultCSSWhiteList=t,M}var le={},We;function Xe(){if(We)return le;We=1;var o=pe();function t(n){var f=o.spaceIndex(n),u;return f===-1?u=n.slice(1,-1):u=n.slice(1,f+1),u=o.trim(u).toLowerCase(),u.slice(0,1)==="/"&&(u=u.slice(1)),u.slice(-1)==="/"&&(u=u.slice(0,-1)),u}function a(n){return n.slice(0,2)==="</"}function r(n,f,u){var C="",v=0,T=!1,E=!1,_=0,I=n.length,R="",S="";e:for(_=0;_<I;_++){var p=n.charAt(_);if(T===!1){if(p==="<"){T=_;continue}}else if(E===!1){if(p==="<"){C+=u(n.slice(v,_)),T=_,v=_;continue}if(p===">"||_===I-1){C+=u(n.slice(v,T)),S=n.slice(T,_+1),R=t(S),C+=f(T,C.length,R,S,a(S)),v=_+1,T=!1;continue}if(p==='"'||p==="'")for(var h=1,b=n.charAt(_-h);b.trim()===""||b==="=";){if(b==="="){E=p;continue e}b=n.charAt(_-++h)}}else if(p===E){E=!1;continue}}return v<I&&(C+=u(n.substr(v))),C}var i=/[^a-zA-Z0-9\\_:.-]/gim;function e(n,f){var u=0,C=0,v=[],T=!1,E=n.length;function _(h,b){if(h=o.trim(h),h=h.replace(i,"").toLowerCase(),!(h.length<1)){var O=f(h,b||"");O&&v.push(O)}}for(var I=0;I<E;I++){var R=n.charAt(I),S,p;if(T===!1&&R==="="){T=n.slice(u,I),u=I+1,C=n.charAt(u)==='"'||n.charAt(u)==="'"?u:c(n,I+1);continue}if(T!==!1&&I===C){if(p=n.indexOf(R,I+1),p===-1)break;S=o.trim(n.slice(C+1,p)),_(T,S),T=!1,I=p,u=I+1;continue}if(/\s|\n|\t/.test(R))if(n=n.replace(/\s|\n|\t/g," "),T===!1)if(p=l(n,I),p===-1){S=o.trim(n.slice(u,I)),_(S),T=!1,u=I+1;continue}else{I=p-1;continue}else if(p=g(n,I-1),p===-1){S=o.trim(n.slice(u,I)),S=m(S),_(T,S),T=!1,u=I+1;continue}else continue}return u<n.length&&(T===!1?_(n.slice(u)):_(T,m(o.trim(n.slice(u))))),o.trim(v.join(" "))}function l(n,f){for(;f<n.length;f++){var u=n[f];if(u!==" ")return u==="="?f:-1}}function c(n,f){for(;f<n.length;f++){var u=n[f];if(u!==" ")return u==="'"||u==='"'?f:-1}}function g(n,f){for(;f>0;f--){var u=n[f];if(u!==" ")return u==="="?f:-1}}function A(n){return n[0]==='"'&&n[n.length-1]==='"'||n[0]==="'"&&n[n.length-1]==="'"}function m(n){return A(n)?n.substr(1,n.length-2):n}return le.parseTag=r,le.parseAttr=e,le}var fe,qe;function wt(){if(qe)return fe;qe=1;var o=de().FilterCSS,t=Ke(),a=Xe(),r=a.parseTag,i=a.parseAttr,e=pe();function l(n){return n==null}function c(n){var f=e.spaceIndex(n);if(f===-1)return{html:"",closing:n[n.length-2]==="/"};n=e.trim(n.slice(f+1,-1));var u=n[n.length-1]==="/";return u&&(n=e.trim(n.slice(0,-1))),{html:n,closing:u}}function g(n){var f={};for(var u in n)f[u]=n[u];return f}function A(n){var f={};for(var u in n)Array.isArray(n[u])?f[u.toLowerCase()]=n[u].map(function(C){return C.toLowerCase()}):f[u.toLowerCase()]=n[u];return f}function m(n){n=g(n||{}),n.stripIgnoreTag&&(n.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),n.onIgnoreTag=t.onIgnoreTagStripAll),n.whiteList||n.allowList?n.whiteList=A(n.whiteList||n.allowList):n.whiteList=t.whiteList,this.attributeWrapSign=n.singleQuotedAttributeValue===!0?"'":t.attributeWrapSign,n.onTag=n.onTag||t.onTag,n.onTagAttr=n.onTagAttr||t.onTagAttr,n.onIgnoreTag=n.onIgnoreTag||t.onIgnoreTag,n.onIgnoreTagAttr=n.onIgnoreTagAttr||t.onIgnoreTagAttr,n.safeAttrValue=n.safeAttrValue||t.safeAttrValue,n.escapeHtml=n.escapeHtml||t.escapeHtml,this.options=n,n.css===!1?this.cssFilter=!1:(n.css=n.css||{},this.cssFilter=new o(n.css))}return m.prototype.process=function(n){if(n=n||"",n=n.toString(),!n)return"";var f=this,u=f.options,C=u.whiteList,v=u.onTag,T=u.onIgnoreTag,E=u.onTagAttr,_=u.onIgnoreTagAttr,I=u.safeAttrValue,R=u.escapeHtml,S=f.attributeWrapSign,p=f.cssFilter;u.stripBlankChar&&(n=t.stripBlankChar(n)),u.allowCommentTag||(n=t.stripCommentTag(n));var h=!1;u.stripIgnoreTagBody&&(h=t.StripTagBody(u.stripIgnoreTagBody,T),T=h.onIgnoreTag);var b=r(n,function(O,G,D,$,x){var B={sourcePosition:O,position:G,isClosing:x,isWhite:Object.prototype.hasOwnProperty.call(C,D)},U=v(D,$,B);if(!l(U))return U;if(B.isWhite){if(B.isClosing)return"</"+D+">";var y=c($),L=C[D],N=i(y.html,function(P,z){var j=e.indexOf(L,P)!==-1,W=E(D,P,z,j);return l(W)?j?(z=I(D,P,z,p),z?P+"="+S+z+S:P):(W=_(D,P,z,j),l(W)?void 0:W):W});return $="<"+D,N&&($+=" "+N),y.closing&&($+=" /"),$+=">",$}else return U=T(D,$,B),l(U)?R($):U},R);return h&&(b=h.remove(b)),b},fe=m,fe}var ze;function xt(){return ze||(ze=1,function(o,t){var a=Ke(),r=Xe(),i=wt();function e(c,g){var A=new i(g);return A.process(c)}t=o.exports=e,t.filterXSS=e,t.FilterXSS=i,function(){for(var c in a)t[c]=a[c];for(var g in r)t[g]=r[g]}(),typeof window<"u"&&(window.filterXSS=o.exports);function l(){return typeof self<"u"&&typeof DedicatedWorkerGlobalScope<"u"&&self instanceof DedicatedWorkerGlobalScope}l()&&(self.filterXSS=o.exports)}(se,se.exports)),se.exports}xt();function St(o){return String(o).trim().toLowerCase()==="true"}const he=new Map;async function Rt(o){if(he.has(o))return he.get(o);try{const t=F.runtime.getURL(`_locales/${o}/messages.json`),a=await fetch(t);if(!a.ok)return null;const r=await a.json();return he.set(o,r),r}catch{return null}}async function He(o,t){let a=t;if(!a||a.length!==2){const i=await ct();a=vt.find(l=>l.name===i||l.locale===i)?.code||(i?.length===2?i:"en")}const r=await Rt(a);return r&&r[o]?.message?r[o].message:null}const Z={ICON_SUCCESS:"âœ…",ICON_WARNING:"âš ï¸",ICON_STATUS:"â³",ICON_ERROR:"âŒ",ICON_INFO:"ðŸ”µ",ICON_REVERT:"â†©ï¸"};class Ot{constructor(t){this.errorHandler=t||{handle:()=>{}},this.map={error:{title:"Translate It! - Error",icon:Z.ICON_ERROR,cls:"AIWC-error",dur:5e3},warning:{title:"Translate It! - Warning",icon:Z.ICON_WARNING,cls:"AIWC-warning",dur:4e3},success:{title:"Translate It! - Success",icon:Z.ICON_SUCCESS,cls:"AIWC-success",dur:3e3},info:{title:"Translate It! - Info",icon:Z.ICON_INFO,cls:"AIWC-info",dur:3e3},status:{title:"Translate It! - Status",icon:Z.ICON_STATUS,cls:"AIWC-status",dur:2e3},revert:{title:"Translate It! - Revert",icon:Z.ICON_REVERT,cls:"AIWC-revert",dur:800}},this.container=null,this.canShowInPage=!1,this._setupLocaleListener()}_ensureContainerExists(){if(this.container&&document.body.contains(this.container)){this.canShowInPage=!0;return}if(typeof document>"u"||!document.body||typeof document.createElement!="function"){d("[NotificationManager] DOM not ready or capable for in-page notifications."),this.canShowInPage=!1;return}try{const t="AIWritingCompanion-notifications";let a=document.getElementById(t);if(a){this.container=a,this.canShowInPage=!0,this._applyAlignment(),d("[NotificationManager] Re-attached to existing container.");return}a=document.createElement("div"),a.id=t,Object.assign(a.style,{position:"fixed",top:"20px",right:"20px",left:"auto",zIndex:"2147483646",display:"flex",flexDirection:"column",gap:"10px",pointerEvents:"none",direction:"ltr",textAlign:"left"}),document.body.appendChild(a),this.container=a,this.canShowInPage=!0,this._applyAlignment(),d("[NotificationManager] Container created and appended successfully.")}catch(t){if(d("[NotificationManager] Environment not compatible for in-page notifications due to error:",t.message),this.canShowInPage=!1,this.container){try{this.container.remove()}catch{}this.container=null}}}_setupLocaleListener(){F.storage&&F.storage.onChanged&&F.storage.onChanged.addListener((t,a)=>{a==="local"&&t.APPLICATION_LOCALIZE&&this.container&&this._applyAlignment()})}async _applyAlignment(){if(this.container)try{const t=await He("IsRTL"),a=St(t);this.container.style.right="20px",this.container.style.left="auto",this.container.style.direction=a?"rtl":"ltr",this.container.style.textAlign="right"}catch(t){this.container.style.right="20px",this.container.style.left="auto",this.container.style.direction="ltr",this.container.style.textAlign="left",d("[NotificationManager] Alignment application failed, using defaults:",t)}}show(t,a="info",r=!0,i=null,e){this._ensureContainerExists();const l=this.map[a]||this.map.info,c=i??l.dur;if(this.canShowInPage)try{return this._toastInPage(t,l,r,c,e)}catch(g){d("[NotificationManager] In-page notification failed, will fallback.",g)}return d(`[NotificationManager] In-page not available. Sending notification request to background for: "${t}"`),$t()&&F.runtime.sendMessage({action:"show_os_notification",payload:{message:t,title:l.title,type:a}}).catch(g=>{d("[NotificationManager] Could not send message to background script.",g)}),null}dismiss(t){if(!(!t||typeof t.remove!="function"||!t.parentNode))try{t.style.opacity="0",setTimeout(()=>{try{t.parentNode&&t.remove()}catch{}},500)}catch(a){d("[NotificationManager] Error dismissing notification:",a)}}_toastInPage(t,a,r,i,e){if(!this.container)return null;const l=document.createElement("div");l.className=`AIWC-notification ${a.cls}`,l.style.cssText=`
      background: #fff; color: #333; padding: 10px 15px; border-radius: 6px;
      font-size: 14px; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex; align-items: center; cursor: ${e?"pointer":"default"};
      opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: auto; max-width: 300px; word-wrap: break-word;
    `;const c=document.createElement("span");c.textContent=a.icon,c.style.marginRight=this.container.style.direction==="rtl"?"0":"8px",c.style.marginLeft=this.container.style.direction==="rtl"?"8px":"0";const g=document.createElement("span");return g.textContent=t,l.appendChild(c),l.appendChild(g),e&&l.addEventListener("click",()=>{try{e()}catch(A){d("[NotificationManager] onClick error:",A)}this.dismiss(l)},{once:!0}),this.container.appendChild(l),setTimeout(()=>{l.style.opacity="1",l.style.transform="translateY(0)"},10),r&&a.cls!=="AIWC-status"&&setTimeout(()=>this.dismiss(l),i),l}reset(){if(this.canShowInPage=!1,this.container){try{this.container.remove()}catch{}this.container=null}}isReady(){const t=!!(this.container&&document.body.contains(this.container));return{canShowInPage:this.canShowInPage||t,containerAvailable:t}}}class s{static API="API";static HTTP_ERROR="HTTP_ERROR";static NETWORK_ERROR="NETWORK_ERROR";static API_RESPONSE_INVALID="API_RESPONSE_INVALID";static SERVICE="SERVICE";static VALIDATION="VALIDATION";static TAB_AVAILABILITY="TAB";static CONTEXT="CONTEXT";static EXTENSION_CONTEXT_INVALIDATED="EXTENSION_CONTEXT_INVALIDATED";static UI="UI";static INTEGRATION="INTEGRATION";static SUBTITLE="SUBTITLE";static SCREEN_CAPTURE="SCREEN_CAPTURE";static UNKNOWN="UNKNOWN";static PROMPT_INVALID="PROMPT_INVALID";static TEXT_EMPTY="TEXT_EMPTY";static TEXT_TOO_LONG="TEXT_TOO_LONG";static TRANSLATION_NOT_FOUND="TRANSLATION_NOT_FOUND";static TRANSLATION_FAILED="TRANSLATION_FAILED";static LANGUAGE_PAIR_NOT_SUPPORTED="LANGUAGE_PAIR_NOT_SUPPORTED";static API_KEY_MISSING="API_KEY_MISSING";static API_KEY_INVALID="API_KEY_INVALID";static API_URL_MISSING="API_URL_MISSING";static MODEL_MISSING="MODEL_MISSING";static MODEL_OVERLOADED="MODEL_OVERLOADED";static QUOTA_EXCEEDED="QUOTA_EXCEEDED";static INSUFFICIENT_BALANCE="INSUFFICIENT_BALANCE";static FORBIDDEN_ERROR="FORBIDDEN_ERROR";static INVALID_REQUEST="INVALID_REQUEST";static GEMINI_QUOTA_REGION="GEMINI_QUOTA_REGION";static SERVER_ERROR="SERVER_ERROR";static RATE_LIMIT_REACHED="RATE_LIMIT_REACHED";static IMPORT_PASSWORD_REQUIRED="IMPORT_PASSWORD_REQUIRED";static IMPORT_PASSWORD_INCORRECT="IMPORT_PASSWORD_INCORRECT";static SCREEN_CAPTURE_FAILED="SCREEN_CAPTURE_FAILED";static SCREEN_CAPTURE_PERMISSION_DENIED="SCREEN_CAPTURE_PERMISSION_DENIED";static SCREEN_CAPTURE_NOT_SUPPORTED="SCREEN_CAPTURE_NOT_SUPPORTED";static IMAGE_PROCESSING_FAILED="IMAGE_PROCESSING_FAILED";static PROVIDER_IMAGE_NOT_SUPPORTED="PROVIDER_IMAGE_NOT_SUPPORTED"}function Pt(o=""){if(o&&typeof o=="object"&&o.type)return o.type;if(o&&typeof o=="object"&&o.statusCode){const a=o.statusCode;if(typeof a=="number"&&a>=400&&a<600)switch(a){case 401:return s.API_KEY_INVALID;case 402:return s.INSUFFICIENT_BALANCE;case 403:return s.FORBIDDEN_ERROR;case 404:return s.MODEL_MISSING;case 400:case 422:return s.INVALID_REQUEST;case 429:return s.RATE_LIMIT_REACHED;case 500:case 502:case 503:case 524:return s.SERVER_ERROR;default:return s.HTTP_ERROR}}if(typeof o=="string"){const a=o.trim();if(Object.values(s).includes(a))return a}const t=String(o).toLowerCase().trim();return t.includes("text is empty")?s.TEXT_EMPTY:t.includes("prompt is invalid")?s.PROMPT_INVALID:t.includes("text is too long")||t.includes("too long")?s.TEXT_TOO_LONG:t.includes("translation not found")?s.TRANSLATION_NOT_FOUND:t.includes("translation failed")?s.TRANSLATION_FAILED:t.includes("translation not available")||t.includes("language pair not supported")||t.includes("language not supported")?s.LANGUAGE_PAIR_NOT_SUPPORTED:t.includes("password is required to import")||t.includes("password is required for decryption")||t.includes("password required to decrypt")?s.IMPORT_PASSWORD_REQUIRED:t.includes("incorrect password")||t.includes("wrong password")||t.includes("invalid password")||t.includes("password or corrupted data")?s.IMPORT_PASSWORD_INCORRECT:t.includes("wrong api key")||t.includes("api key not valid")||t.includes("no auth credentials")||t.includes("incorrect api key provided")||t.includes("api key expired")||t.includes("renew the api key")||t.includes("api key expired")||t.includes("renew the api key")||t.includes("authentication fails")?s.API_KEY_INVALID:t.includes("api key is missing")||t.includes("key missing")?s.API_KEY_MISSING:t.includes("http 400 error")||t.includes("http 400")||t.includes("400 error")?s.INVALID_REQUEST:t.includes("api url")&&t.includes("missing")||t.includes("no endpoints found")||t.includes("no endpoint")||t.includes("no endpoints")?s.API_URL_MISSING:t.includes("not a valid model id")||t.includes("invalid model")||t.includes("model not found")||t.includes("model is missing")||t.includes("model not available")||t.includes("is not found for api version")||t.includes("the model `")&&t.includes("does not exist or you do not have access to it")?s.MODEL_MISSING:t.includes("the model is overloaded")||t.includes("overloaded")?s.MODEL_OVERLOADED:t.includes("quota exceeded")&&t.includes("region")||t.includes("location is not supported")?(d("[ErrorMatcher] Quota exceeded with region, indicating Gemini-specific quota."),s.GEMINI_QUOTA_REGION):t.includes("quota exceeded")||t.includes("gemini quota")||t.includes("resource has been exhausted")||t.includes("check quota")||t.includes("requires more credits")||t.includes("fewer max_tokens")||t.includes("insufficient balance")||t.includes("exceeded your current quota")||t.includes("check your plan and billing details")?s.QUOTA_EXCEEDED:t.includes("failed to fetch")||t.includes("network failure")||t.includes("connection failed")||t.includes("networkerror")||t.includes("networkerror when attempting to fetch resource")?s.NETWORK_ERROR:t.includes("http error")||t.includes("http status")||t.includes("http response")||t.includes("operation was aborted")||t.includes("the operation was aborted.")?s.HTTP_ERROR:t.includes("extension context invalidated")||t.includes("extension context")&&t.includes("invalidated")?s.EXTENSION_CONTEXT_INVALIDATED:t.includes("context")||t.includes("context invalid")||t.includes("extension context")||t.includes("context invalidated")||t.includes("not establish")||t.includes("not establish connection")?s.CONTEXT:s.UNKNOWN}const je={[s.TEXT_EMPTY]:"Text is empty",[s.PROMPT_INVALID]:"Prompt is invalid",[s.TEXT_TOO_LONG]:"Text is too long",[s.TRANSLATION_NOT_FOUND]:"Translation not found",[s.TRANSLATION_FAILED]:"Translation failed",[s.LANGUAGE_PAIR_NOT_SUPPORTED]:"Language pair not supported by the selected translation service",[s.API]:"API error",[s.API_KEY_MISSING]:"API Key is missing",[s.API_KEY_INVALID]:"API Key is wrong or invalid",[s.API_URL_MISSING]:"API URL is missing",[s.MODEL_MISSING]:"AI Model is missing or invalid",[s.MODEL_OVERLOADED]:"The Model is overloaded",[s.QUOTA_EXCEEDED]:"You exceeded your current quota",[s.GEMINI_QUOTA_REGION]:"You reached the Gemini quota. (Region issue)",[s.INVALID_REQUEST]:"Invalid request format or parameters.",[s.INSUFFICIENT_BALANCE]:"Insufficient balance or credits for the selected API.",[s.FORBIDDEN_ERROR]:"Access denied. Check permissions or potential content moderation.",[s.RATE_LIMIT_REACHED]:"Rate limit reached. Please pace your requests or try again later.",[s.SERVER_ERROR]:"The service provider's server encountered an error. Please try again later.",[s.IMPORT_PASSWORD_REQUIRED]:"Password is required to import encrypted settings",[s.IMPORT_PASSWORD_INCORRECT]:"Incorrect password or corrupted data",[s.SCREEN_CAPTURE_FAILED]:"Failed to capture screen. Please try again.",[s.SCREEN_CAPTURE_PERMISSION_DENIED]:"Screen capture permission denied. Please enable permissions and try again.",[s.SCREEN_CAPTURE_NOT_SUPPORTED]:"Screen capture is not supported in this browser or context.",[s.IMAGE_PROCESSING_FAILED]:"Failed to process captured image. Please try again.",[s.PROVIDER_IMAGE_NOT_SUPPORTED]:"Current translation provider does not support image translation. Please select an AI provider.",[s.NETWORK_ERROR]:"Connection to server failed",[s.HTTP_ERROR]:"HTTP error",[s.CONTEXT]:"Extension context lost",[s.EXTENSION_CONTEXT_INVALIDATED]:"Extension reloaded, please refresh page",[s.UNKNOWN]:"An unknown error occurred",[s.TAB_AVAILABILITY]:"Tab not available",[s.UI]:"User Interface error",[s.INTEGRATION]:"Integration error",[s.SERVICE]:"Service error",[s.VALIDATION]:"Validation error"};async function Lt(o){const t=o?.startsWith("ERRORS_")?o:`ERRORS_${o}`;let a=await He(t);return(!a||!a.trim())&&(a=je[o]||je[s.UNKNOWN]),a}const kt=new Set([s.CONTEXT,s.EXTENSION_CONTEXT_INVALIDATED]),Dt=new Set([s.CONTEXT,s.EXTENSION_CONTEXT_INVALIDATED,s.API,s.API_KEY_INVALID,s.API_KEY_MISSING,s.API_URL_MISSING,s.MODEL_MISSING,s.MODEL_OVERLOADED,s.QUOTA_EXCEEDED,s.GEMINI_QUOTA_REGION,s.NETWORK_ERROR,s.HTTP_ERROR,s.INTEGRATION,s.SERVICE,s.VALIDATION,s.UI,s.PROMPT_INVALID,s.TEXT_EMPTY,s.TEXT_TOO_LONG,s.TRANSLATION_NOT_FOUND,s.TRANSLATION_FAILED,s.LANGUAGE_PAIR_NOT_SUPPORTED,s.TAB_AVAILABILITY,s.IMPORT_PASSWORD_INCORRECT,s.IMPORT_PASSWORD_REQUIRED]),Ut=new Set([s.API_KEY_INVALID,s.API_KEY_MISSING,s.MODEL_OVERLOADED,s.MODEL_MISSING,s.API_URL_MISSING,s.QUOTA_EXCEEDED,s.HTTP_ERROR,s.GEMINI_QUOTA_REGION]);class Mt{constructor(){this.notifier=new Ot,this.displayedErrors=new Set,this.handling=!1}static async processError(t){return t?.then?await t:t}async handle(t,a={}){if(this.handling)return t;this.handling=!0;try{const r=t instanceof Error?t.message:String(t),i=Pt(r),e=await Lt(i);if(await ve().catch(()=>w.DEBUG_MODE)&&!Dt.has(i)&&console.error(`[${i}] ${r}`,t.stack),kt.has(i))return t;const c=Ut.has(i)?()=>Gt("api"):void 0;return this._notifyUser(e,a.type||s.SERVICE,c),t}finally{this.handling=!1}}_logError(t,a){console.error(`[ErrorService] ${t.name}: ${t.message}
Context: ${a.context}
Type: ${a.type}
Stack: ${t.stack}`)}_notifyUser(t,a,r){if(this.displayedErrors.has(t))return;const e={[s.API]:"error",[s.UI]:"error",[s.NETWORK_ERROR]:"warning",[s.HTTP_ERROR]:"warning",[s.SERVICE]:"error",[s.CONTEXT]:"warning",[s.VALIDATION]:"warning",[s.INTEGRATION]:"warning",[s.API_KEY_INVALID]:"error",[s.API_KEY_MISSING]:"error",[s.API_URL_MISSING]:"error",[s.MODEL_MISSING]:"error",[s.MODEL_OVERLOADED]:"warning",[s.QUOTA_EXCEEDED]:"warning",[s.GEMINI_QUOTA_REGION]:"warning",[s.LANGUAGE_PAIR_NOT_SUPPORTED]:"warning"}[a]||"error";this.notifier.show(t,e,!0,5e3,r),this.displayedErrors.add(t),setTimeout(()=>this.displayedErrors.delete(t),5500)}}new Mt;const d=(...o)=>{st().then(t=>{t&&console.debug(...o)})},$t=()=>{try{return!!F?.runtime?.id&&!!F?.storage?.local}catch{return!1}},Gt=(o=null)=>{F.runtime.sendMessage({action:"open_options_page",data:{anchor:o}}).catch(t=>{console.error("Error sending open_options_page message:",t)})};class H{constructor(t){this.providerName=t,this.sessionContext=null}async translate(t,a,r,i){throw new Error(`translate method must be implemented by ${this.constructor.name}`)}async translateImage(t,a,r,i){throw new Error(`translateImage method not supported by ${this.constructor.name}`)}async _executeApiCall({url:t,fetchOptions:a,extractResponse:r,context:i}){d(`[${this.providerName}] _executeApiCall starting for context: ${i}`),d(`[${this.providerName}] _executeApiCall URL: ${t}`),d(`[${this.providerName}] _executeApiCall fetchOptions:`,a);try{const e=await fetch(t,a);if(d(`[${this.providerName}] _executeApiCall response status: ${e.status} ${e.statusText}`),!e.ok){let g={};try{g=await e.json()}catch{}const A=g.detail||g.error?.message||e.statusText||`HTTP ${e.status}`;d(`[${this.providerName}] _executeApiCall HTTP error: ${A}`,g);const m=new Error(A);throw m.type=s.HTTP_ERROR,m.statusCode=e.status,m.context=i,m}const l=await e.json();d(`[${this.providerName}] _executeApiCall response data:`,l);const c=r(l,e.status);if(d(`[${this.providerName}] _executeApiCall extracted result:`,c),c===void 0){d(`[${this.providerName}] _executeApiCall result is undefined - treating as invalid response`);const g=new Error(s.API_RESPONSE_INVALID);throw g.type=s.API,g.statusCode=e.status,g.context=i,g}return d(`[${this.providerName}] _executeApiCall success for context: ${i}`),c}catch(e){if(e instanceof TypeError&&/NetworkError/.test(e.message)){const l=new Error(e.message);throw l.type=s.NETWORK_ERROR,l.context=i,l}throw e}}_validateConfig(t,a,r){for(const i of a)if(!t[i]){const e=i.toLowerCase().includes("key")?s.API_KEY_MISSING:i.toLowerCase().includes("url")?s.API_URL_MISSING:i.toLowerCase().includes("model")?s.AI_MODEL_MISSING:s.API,l=new Error(e);throw l.type=e,l.context=r,l}}storeSessionContext(t){this.sessionContext={...t,timestamp:Date.now()}}resetSessionContext(){this.sessionContext=null}shouldResetSession(){return this.sessionContext&&Date.now()-this.sessionContext.lastUsed>3e5}_isSameLanguage(t,a){return t===a}_buildMessagePayload(t){let a="";try{const r=JSON.parse(t.fetchOptions.body);r.contents&&Array.isArray(r.contents)&&r.contents[0].parts?a=r.contents[0].parts[0].text:r.message?a=r.message:r.messages&&Array.isArray(r.messages)&&r.messages[0].content&&(a=r.messages[0].content)}catch{}return{promptText:a,sourceLanguage:t.sourceLanguage||"auto",targetLanguage:t.targetLanguage||"auto",translationMode:t.translationMode||""}}}const Ae="auto",Ye=o=>o,Je=`

---

`,Ft={afrikaans:"af",albanian:"sq",arabic:"ar",azerbaijani:"az",belarusian:"be",bengali:"bn",bulgarian:"bg",catalan:"ca",cebuano:"ceb","chinese (simplified)":"zh",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",farsi:"fa",persian:"fa",filipino:"fil",finnish:"fi",french:"fr",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",malay:"ms",malayalam:"ml",marathi:"mr",nepali:"ne",norwegian:"no",odia:"or",pashto:"ps",polish:"pl",portuguese:"pt",punjabi:"pa",romanian:"ro",russian:"ru",serbian:"sr",sinhala:"si",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",telugu:"te",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",uzbek:"uz",vietnamese:"vi"};class Bt extends H{constructor(){super("GoogleTranslate")}_formatDictionaryAsMarkdown(t){if(!t||t.trim()==="")return"";const a=t.trim().split(`
`).filter(i=>i.trim()!=="");if(a.length===0)return"";let r="";return a.forEach(i=>{const e=i.indexOf(":");if(e>0){const l=i.substring(0,e).trim(),c=i.substring(e+1).trim();l&&c&&(r+=`**${l}:** ${c}

`)}else i.trim()&&(r+=`**${i.trim()}**

`)}),r.trim()}_isSpecificTextJsonFormat(t){return Array.isArray(t)&&t.length>0&&t.every(a=>typeof a=="object"&&a!==null&&typeof a.text=="string")}_getLangCode(t){if(!t||typeof t!="string")return"auto";const a=t.toLowerCase();return Ft[a]||a}async translate(t,a,r,i=null){if(this._isSameLanguage(a,r))return null;try{const E=await F.i18n.detectLanguage(t);if(E?.isReliable&&E.languages.length>0){const I=E.languages[0].language.split("-")[0],R=Ye(r).split("-")[0];I===R&&([a,r]=[r,a])}else{const _=Ye(r).split("-")[0];J(t)&&(_==="fa"||_==="ar")&&([a,r]=[r,a])}}catch(E){d(`[${this.providerName}] Language detection failed:`,E)}i===V.Field&&(a=Ae),i===V.Subtitle&&(a=Ae);let e=!1,l,c=[t];const g=`${this.providerName.toLowerCase()}-translate`;try{const E=JSON.parse(t);this._isSpecificTextJsonFormat(E)&&(e=!0,l=E,c=l.map(_=>_.text))}catch{}const A=await lt(),m=a===Ae?"auto":this._getLangCode(a),n=this._getLangCode(r);if(m===n&&!e)return t;const f=new URL(A),C=await xe()&&i!==V.Field&&i!==V.Subtitle,v=["client=gtx",`sl=${m}`,`tl=${n}`,"dt=t"];C&&v.push("dt=bd"),v.push(`q=${encodeURIComponent(c.join(Je))}`),f.search=v.join("&");const T=await this._executeApiCall({url:f.toString(),fetchOptions:{method:"GET"},extractResponse:E=>{if(!E?.[0])return;const _=E[0].map(R=>R[0]||"").join("");let I="";return C&&E[1]&&(I=E[1].map(R=>{const S=R[0]||"",p=R[1]||[];return`${S}${S!==""?": ":""}${p.join(", ")}
`}).join("")),{resultText:_,candidateText:I.trim()}},context:g});if(e){const E=T.resultText.split(Je);if(E.length!==l.length)return d("Google Translate: JSON reconstruction failed due to segment mismatch."),T.resultText;const _=l.map((I,R)=>({...I,text:E[R]?.trim()||""}));return JSON.stringify(_,null,2)}else{if(T.candidateText){const E=this._formatDictionaryAsMarkdown(T.candidateText);return`${T.resultText}

${E}`}return T.resultText}}}const Ee="auto",Te=o=>o,Qe=`

---

`,Vt={auto:"auto-detect",af:"af",am:"am",ar:"ar",az:"az",bg:"bg",bs:"bs",ca:"ca",cs:"cs",cy:"cy",da:"da",de:"de",el:"el",en:"en",es:"es",et:"et",fa:"fa",fi:"fi",fr:"fr",ga:"ga",gu:"gu",hi:"hi",hmn:"mww",hr:"hr",ht:"ht",hu:"hu",hy:"hy",id:"id",is:"is",it:"it",ja:"ja",kk:"kk",km:"km",kn:"kn",ko:"ko",ku:"ku",lo:"lo",lt:"lt",lv:"lv",mg:"mg",mi:"mi",ml:"ml",mr:"mr",ms:"ms",mt:"mt",my:"my",ne:"ne",nl:"nl",no:"nb",pa:"pa",pl:"pl",ps:"ps",ro:"ro",ru:"ru",sk:"sk",sl:"sl",sm:"sm",sq:"sq",sr:"sr-Cyrl",sv:"sv",sw:"sw",ta:"ta",te:"te",th:"th",tr:"tr",uk:"uk",ur:"ur",vi:"vi",iw:"he",tl:"fil",pt:"pt","zh-CN":"zh-Hans","zh-TW":"zh-Hant"},Kt={afrikaans:"af",albanian:"sq",arabic:"ar",azerbaijani:"az",belarusian:"be",bengali:"bn",bulgarian:"bg",catalan:"ca",cebuano:"ceb","chinese (simplified)":"zh-CN",chinese:"zh-CN",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",farsi:"fa",persian:"fa",filipino:"fil",finnish:"fi",french:"fr",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",malay:"ms",malayalam:"ml",marathi:"mr",nepali:"ne",norwegian:"no",odia:"or",pashto:"ps",polish:"pl",portuguese:"pt",punjabi:"pa",romanian:"ro",russian:"ru",serbian:"sr",sinhala:"si",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",telugu:"te",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",uzbek:"uz",vietnamese:"vi"};class X extends H{static bingBaseUrl="https://www.bing.com/ttranslatev3";static bingTokenUrl="https://www.bing.com/translator";static bingAccessToken=null;constructor(){super("BingTranslate")}_isSpecificTextJsonFormat(t){return Array.isArray(t)&&t.length>0&&t.every(a=>typeof a=="object"&&a!==null&&typeof a.text=="string")}_getLangCode(t){if(!t||typeof t!="string"||t===Ee)return"auto-detect";const a=t.toLowerCase(),r=Kt[a]||a;return Vt[r]||r}async _getBingAccessToken(){try{if(!X.bingAccessToken||Date.now()-X.bingAccessToken.tokenTs>X.bingAccessToken.tokenExpiryInterval){d(`[${this.providerName}] Fetching new Bing access token`);const t=await fetch(X.bingTokenUrl);if(!t.ok)throw new Error(`Failed to fetch token page: ${t.status}`);const a=await t.text(),r=a.match(/IG:"([^"]+)"/),i=a.match(/data-iid="([^"]+)"/),e=a.match(/params_AbusePreventionHelper\s?=\s?([^\]]+\])/);if(!r||!i||!e)throw new Error("Failed to extract token parameters from Bing translator page");const l=r[1],c=i[1],[g,A,m]=JSON.parse(e[1]);X.bingAccessToken={IG:l,IID:c,key:g,token:A,tokenTs:Date.now(),tokenExpiryInterval:m,count:0},d(`[${this.providerName}] New Bing access token obtained`)}return X.bingAccessToken}catch(t){d(`[${this.providerName}] Failed to get Bing access token:`,t);const a=new Error(`Failed to get Bing access token: ${t.message}`);throw a.type=s.API,a.context=`${this.providerName.toLowerCase()}-token-fetch`,a}}async _applyLanguageSwapping(t,a,r){try{const i=await F.i18n.detectLanguage(t);if(i?.isReliable&&i.languages.length>0){const l=i.languages[0].language.split("-")[0],c=Te(r).split("-")[0];if(l===c)return d(`[${this.providerName}] Languages swapped: ${l} â†’ ${c}`),[r,a]}else{const e=Te(r).split("-")[0];if(J(t)&&(e==="fa"||e==="ar"))return d(`[${this.providerName}] Languages swapped using regex fallback`),[r,a]}}catch(i){d(`[${this.providerName}] Language detection failed:`,i);const e=Te(r).split("-")[0];if(J(t)&&(e==="fa"||e==="ar"))return[r,a]}return[a,r]}async translate(t,a,r,i=null){if(this._isSameLanguage(a,r))return null;[a,r]=await this._applyLanguageSwapping(t,a,r),i===V.Field&&(a=Ee),i===V.Subtitle&&(a=Ee);const e=this._getLangCode(a),l=this._getLangCode(r);if(e===l)return t;let c=!1,g,A=[t];try{const n=JSON.parse(t);this._isSpecificTextJsonFormat(n)&&(c=!0,g=n,A=g.map(f=>f.text))}catch{}const m=`${this.providerName.toLowerCase()}-translate`;try{const{token:n,key:f,IG:u,IID:C}=await this._getBingAccessToken(),v=A.join(Qe),T=new URLSearchParams({text:v,fromLang:e,to:l,token:n,key:f}),E=new URL(X.bingBaseUrl);E.searchParams.set("IG",u),E.searchParams.set("IID",C&&C.length?`${C}.${X.bingAccessToken.count++}`:""),E.searchParams.set("isVertical","1");const _=await this._executeApiCall({url:E.toString(),fetchOptions:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":navigator.userAgent},body:T},extractResponse:I=>{if(!I||!Array.isArray(I)||!I[0])return;const R=I[0];if(!R.translations||!Array.isArray(R.translations))return;const S=R.translations[0]?.text;if(!S)return;let p="",h="";return R.detectedLanguage?.language&&(p=R.detectedLanguage.language),I[1]&&I[1].inputTransliteration&&(h=I[1].inputTransliteration),{targetText:S,detectedLang:p,transliteration:h}},context:m});if(c){const I=_.targetText.split(Qe);if(I.length!==g.length)return d(`[${this.providerName}] JSON reconstruction failed due to segment mismatch.`),_.targetText;const R=g.map((S,p)=>({...S,text:I[p]?.trim()||""}));return JSON.stringify(R,null,2)}else return _.targetText}catch(n){throw n.type||(n.message?.includes("token")||n.message?.includes("Token")?(n.type=s.API_KEY_MISSING,n.context=`${this.providerName.toLowerCase()}-token-error`):n.message?.includes("rate limit")||n.message?.includes("quota")?(n.type=s.API_QUOTA_EXCEEDED,n.context=`${this.providerName.toLowerCase()}-quota-exceeded`):(n.type=s.API,n.context=`${this.providerName.toLowerCase()}-translation-error`),d(`[${this.providerName}] Translation error:`,n)),n}}static cleanup(){X.bingAccessToken=null}resetSessionContext(){super.resetSessionContext(),X.cleanup()}}const _e="auto",Ie=o=>o,Ze=`

---

`,Wt={af:"af",sq:"sq",am:"am",ar:"ar",hy:"hy",az:"az",eu:"eu",be:"be",bn:"bn",bs:"bs",bg:"bg",ca:"ca",hr:"hr",cs:"cs",da:"da",nl:"nl",en:"en",eo:"eo",et:"et",fi:"fi",fr:"fr",gl:"gl",ka:"ka",de:"de",el:"el",gu:"gu",ht:"ht",hi:"hi",hu:"hu",is:"is",id:"id",ga:"ga",it:"it",ja:"ja",kn:"kn",kk:"kk",km:"km",ko:"ko",ky:"ky",lo:"lo",la:"la",lv:"lv",lt:"lt",lb:"lb",mk:"mk",mg:"mg",ms:"ms",ml:"ml",mt:"mt",mi:"mi",mr:"mr",mn:"mn",my:"my",ne:"ne",no:"no",fa:"fa",pl:"pl",pt:"pt",pa:"pa",ro:"ro",ru:"ru",gd:"gd",sr:"sr",si:"si",sk:"sk",sl:"sl",es:"es",su:"su",sw:"sw",sv:"sv",tg:"tg",ta:"ta",te:"te",th:"th",tr:"tr",uk:"uk",ur:"ur",uz:"uz",vi:"vi",cy:"cy",xh:"xh",yi:"yi",tl:"tl",iw:"he",jw:"jv","zh-CN":"zh"},Xt={afrikaans:"af",albanian:"sq",arabic:"ar",azerbaijani:"az",belarusian:"be",bengali:"bn",bulgarian:"bg",catalan:"ca",cebuano:"ceb","chinese (simplified)":"zh-CN",chinese:"zh-CN",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",farsi:"fa",persian:"fa",filipino:"fil",finnish:"fi",french:"fr",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",indonesian:"id",italian:"it",japanese:"ja",kannada:"kn",kazakh:"kk",korean:"ko",latvian:"lv",lithuanian:"lt",malay:"ms",malayalam:"ml",marathi:"mr",nepali:"ne",norwegian:"no",odia:"or",pashto:"ps",polish:"pl",portuguese:"pt",punjabi:"pa",romanian:"ro",russian:"ru",serbian:"sr",sinhala:"si",slovak:"sk",slovenian:"sl",spanish:"es",swahili:"sw",swedish:"sv",tagalog:"tl",tamil:"ta",telugu:"te",thai:"th",turkish:"tr",ukrainian:"uk",urdu:"ur",uzbek:"uz",vietnamese:"vi"};class Ne extends H{static mainUrl="https://translate.yandex.net/api/v1/tr.json/translate";constructor(){super("YandexTranslate")}_isSpecificTextJsonFormat(t){return Array.isArray(t)&&t.length>0&&t.every(a=>typeof a=="object"&&a!==null&&typeof a.text=="string")}_getLangCode(t){if(!t||typeof t!="string"||t===_e)return"auto";const a=t.toLowerCase(),r=Xt[a]||a;return Wt[r]||r}_generateUuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const a=Math.random()*16|0;return(t==="x"?a:a&3|8).toString(16)}).replace(/-/g,"")}async _applyLanguageSwapping(t,a,r){try{const i=await F.i18n.detectLanguage(t);if(i?.isReliable&&i.languages.length>0){const l=i.languages[0].language.split("-")[0],c=Ie(r).split("-")[0];if(l===c)return d(`[${this.providerName}] Languages swapped: ${l} â†’ ${c}`),[r,a]}else{const e=Ie(r).split("-")[0];if(J(t)&&(e==="fa"||e==="ar"))return d(`[${this.providerName}] Languages swapped using regex fallback`),[r,a]}}catch(i){d(`[${this.providerName}] Language detection failed:`,i);const e=Ie(r).split("-")[0];if(J(t)&&(e==="fa"||e==="ar"))return[r,a]}return[a,r]}async translate(t,a,r,i=null){if(this._isSameLanguage(a,r))return null;[a,r]=await this._applyLanguageSwapping(t,a,r),i===V.Field&&(a=_e),i===V.Subtitle&&(a=_e);const e=this._getLangCode(a),l=this._getLangCode(r);if(e===l)return t;let c=!1,g,A=[t];try{const n=JSON.parse(t);this._isSpecificTextJsonFormat(n)&&(c=!0,g=n,A=g.map(f=>f.text))}catch{}const m=`${this.providerName.toLowerCase()}-translate`;try{const n=this._generateUuid(),f=A.join(Ze),u=e==="auto"?l:`${e}-${l}`,C=new URLSearchParams({lang:u,text:f}),v=new URL(Ne.mainUrl);v.searchParams.set("id",`${n}-0-0`),v.searchParams.set("srv","android");const T=await this._executeApiCall({url:v.toString(),fetchOptions:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","User-Agent":navigator.userAgent},body:C},extractResponse:E=>{if(!E||E.code!==200||!E.text||!Array.isArray(E.text)||E.text.length===0)return;const _=E.text[0];if(!_)return;let I="";return E.lang&&typeof E.lang=="string"&&(I=E.lang.split("-")[0]),{targetText:_,detectedLang:I,transliteration:""}},context:m});if(c){const E=T.targetText.split(Ze);if(E.length!==g.length)return d(`[${this.providerName}] JSON reconstruction failed due to segment mismatch.`),T.targetText;const _=g.map((I,R)=>({...I,text:E[R]?.trim()||""}));return JSON.stringify(_,null,2)}else return T.targetText}catch(n){throw n.type||(n.message?.includes("rate limit")||n.message?.includes("quota")?(n.type=s.API_QUOTA_EXCEEDED,n.context=`${this.providerName.toLowerCase()}-quota-exceeded`):n.message?.includes("403")||n.message?.includes("401")?(n.type=s.API_KEY_MISSING,n.context=`${this.providerName.toLowerCase()}-auth-error`):(n.type=s.API,n.context=`${this.providerName.toLowerCase()}-translation-error`),d(`[${this.providerName}] Translation error:`,n)),n}}}function qt(o){return Array.isArray(o)&&o.length>0&&o.every(t=>typeof t=="object"&&t!==null&&typeof t.text=="string")}async function ee(o,t,a,r=V.Field){const i=await ut();let e=o,l=!1;try{const m=JSON.parse(o);qt(m)&&(l=!0,e=o)}catch{e=o}let c;l?c=await mt():r===V.Subtitle?c=await pt():r===V.Popup_Translate||r===V.Sidepanel_Translate?c=await dt():await xe()===!0?r===V.Dictionary_Translation?c=await gt():c=await Se():c=await Se();let g;if(r===V.Subtitle)g=c.replace(/\$_{SOURCE}/g,t).replace(/\$_{TARGET}/g,a);else{const m=i.replace(/\$_{SOURCE}/g,t).replace(/\$_{TARGET}/g,a);g=c.replace(/\$_{SOURCE}/g,t).replace(/\$_{TARGET}/g,a).replace(/\$_{USER_RULES}/g,m)}d("Prompt template: ",g),d("Text for translation: ",e);let A;return g.includes("$_{TEXT}")?(A=g.replace(/\$_{TEXT}/g,e),A=g.replace(/\$_{TEXT}/g,e),d("Final prompt with TEXT replacement: ",A)):(A=`${g}

${e}

`,d("Final prompt with appended text: ",A)),A}class zt extends H{constructor(){super("Gemini")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l,c]=await Promise.all([Ce(),we(),ot()]);let g;l==="custom"?g=await be():g=w.GEMINI_MODELS?.find(T=>T.value===l)?.url||w.API_URL,this._validateConfig({apiKey:e,apiUrl:g},["apiKey","apiUrl"],`${this.providerName.toLowerCase()}-translation`),d(`[${this.providerName}] translate input text:`,t);const A=await ee(t,a,r,i);d(`[${this.providerName}] translate built prompt:`,A);let m={contents:[{parts:[{text:A}]}]};const n=w.GEMINI_MODELS?.find(v=>v.value===l);n?.thinking?.supported&&(n.thinking.controllable?c?m.generationConfig={thinkingConfig:{thinkingBudget:-1}}:m.generationConfig={thinkingConfig:{thinkingBudget:0}}:n.thinking.defaultEnabled&&(m.generationConfig={thinkingConfig:{thinkingBudget:-1}}));const f=`${g}?key=${e}`,u={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)},C=`${this.providerName.toLowerCase()}-translation`;d(`[${this.providerName}] about to call _executeApiCall with:`,{url:f.replace(/key=[^&]+/,"key=***"),context:C});try{const v=await this._executeApiCall({url:f,fetchOptions:u,extractResponse:T=>T?.candidates?.[0]?.content?.parts?.[0]?.text,context:C});return d(`[${this.providerName}] _executeApiCall completed with result:`,v),v}catch(v){if(v.message&&v.message.includes("thinkingBudget")&&m.generationConfig?.thinkingConfig){d(`[${this.providerName}] thinking parameter not supported, retrying without thinking...`),delete m.generationConfig;const T={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)},E=await this._executeApiCall({url:f,fetchOptions:T,extractResponse:_=>_?.candidates?.[0]?.content?.parts?.[0]?.text,context:`${C}-fallback`});return d(`[${this.providerName}] fallback _executeApiCall completed with result:`,E),E}throw d(`[${this.providerName}] _executeApiCall failed with error:`,v),v}}async translateImage(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l]=await Promise.all([Ce(),we()]);let c;l==="custom"?c=await be():c=w.GEMINI_MODELS?.find(_=>_.value===l)?.url||w.API_URL,this._validateConfig({apiKey:e,apiUrl:c},["apiKey","apiUrl"],`${this.providerName.toLowerCase()}-image-translation`),d(`[${this.providerName}] translateImage called with mode:`,i);const A=(await Re()).replace(/\$_\{TARGET\}/g,r).replace(/\$_\{SOURCE\}/g,a);d(`[${this.providerName}] translateImage built prompt:`,A);const m=t.match(/^data:image\/([^;]+);base64,(.+)/);if(!m)throw this._createError("IMAGE_PROCESSING_FAILED","Invalid image data format");const[,n,f]=m,u={contents:[{parts:[{text:A},{inlineData:{mimeType:`image/${n}`,data:f}}]}]},C=`${c}?key=${e}`,v={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)},T=`${this.providerName.toLowerCase()}-image-translation`;d(`[${this.providerName}] about to call _executeApiCall for image translation`);try{const E=await this._executeApiCall({url:C,fetchOptions:v,extractResponse:_=>_?.candidates?.[0]?.content?.parts?.[0]?.text,context:T});return d(`[${this.providerName}] image translation completed with result:`,E),E}catch(E){throw d(`[${this.providerName}] image translation failed with error:`,E),E}}_createError(t,a){const r=new Error(a);return r.type=t,r.context=`${this.providerName.toLowerCase()}-provider`,r}}class Ht extends H{constructor(){super("OpenAI")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l,c]=await Promise.all([Oe(),Pe(),Le()]);this._validateConfig({apiKey:e,apiUrl:l},["apiKey","apiUrl"],`${this.providerName.toLowerCase()}-translation`);const g=await ee(t,a,r,i),A={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:c||"gpt-3.5-turbo",messages:[{role:"user",content:g}]})};return this._executeApiCall({url:l,fetchOptions:A,extractResponse:m=>m?.choices?.[0]?.message?.content,context:`${this.providerName.toLowerCase()}-translation`})}async translateImage(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l,c]=await Promise.all([Oe(),Pe(),Le()]);this._validateConfig({apiKey:e,apiUrl:l},["apiKey","apiUrl"],`${this.providerName.toLowerCase()}-image-translation`),d(`[${this.providerName}] translateImage called with mode:`,i);const A=(await Re()).replace(/\$_\{TARGET\}/g,r).replace(/\$_\{SOURCE\}/g,a);d(`[${this.providerName}] translateImage built prompt:`,A);const m=[{role:"user",content:[{type:"text",text:A},{type:"image_url",image_url:{url:t}}]}],n={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:c||"gpt-4o",messages:m,max_tokens:1e3})},f=`${this.providerName.toLowerCase()}-image-translation`;d(`[${this.providerName}] about to call _executeApiCall for image translation`);try{const u=await this._executeApiCall({url:l,fetchOptions:n,extractResponse:C=>C?.choices?.[0]?.message?.content,context:f});return d(`[${this.providerName}] image translation completed with result:`,u),u}catch(u){throw d(`[${this.providerName}] image translation failed with error:`,u),u}}}class jt extends H{constructor(){super("OpenRouter")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l]=await Promise.all([Nt(),yt()]);this._validateConfig({apiKey:e},["apiKey"],`${this.providerName.toLowerCase()}-translation`);const c=await ee(t,a,r,i),g={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":F.runtime.getURL("/"),"X-Title":F.runtime.getManifest().name},body:JSON.stringify({model:l||"openai/gpt-3.5-turbo",messages:[{role:"user",content:c}]})};return this._executeApiCall({url:w.OPENROUTER_API_URL,fetchOptions:g,extractResponse:A=>A?.choices?.[0]?.message?.content,context:`${this.providerName.toLowerCase()}-translation`})}}class Yt extends H{constructor(){super("DeepSeek")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l]=await Promise.all([At(),Et()]);this._validateConfig({apiKey:e},["apiKey"],`${this.providerName.toLowerCase()}-translation`);const c=await ee(t,a,r,i),g={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:l||"deepseek-chat",messages:[{role:"user",content:c}],stream:!1})};return this._executeApiCall({url:w.DEEPSEEK_API_URL,fetchOptions:g,extractResponse:A=>A?.choices?.[0]?.message?.content,context:`${this.providerName.toLowerCase()}-translation`})}}class Jt extends H{constructor(){super("WebAI")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l]=await Promise.all([ft(),ht()]);this._validateConfig({apiUrl:e,apiModel:l},["apiUrl","apiModel"],`${this.providerName.toLowerCase()}-translation`);const c=await ee(t,a,r,i),g={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:c,model:l,images:[],reset_session:this.shouldResetSession()})},A=await this._executeApiCall({url:e,fetchOptions:g,extractResponse:m=>typeof m.response=="string"?m.response:void 0,context:`${this.providerName.toLowerCase()}-translation`});return this.storeSessionContext({model:l,lastUsed:Date.now()}),A}}class Qt extends H{constructor(){super("Custom")}async translate(t,a,r,i){if(this._isSameLanguage(a,r))return null;const[e,l,c]=await Promise.all([Tt(),_t(),It()]);this._validateConfig({apiUrl:e,apiKey:l},["apiUrl","apiKey"],`${this.providerName.toLowerCase()}-translation`);const g=await ee(t,a,r,i),A={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({model:c,messages:[{role:"user",content:g}]})};return this._executeApiCall({url:e,fetchOptions:A,extractResponse:m=>m?.choices?.[0]?.message?.content,context:`${this.providerName.toLowerCase()}-translation`})}}const te="auto",et=`

---

`,Zt={afrikaans:"af",albanian:"sq",arabic:"ar",azerbaijani:"az",belarusian:"be",bengali:"bn",bulgarian:"bg",catalan:"ca","chinese (simplified)":"zh",chinese:"zh",croatian:"hr",czech:"cs",danish:"da",dutch:"nl",english:"en",estonian:"et",farsi:"fa",persian:"fa",filipino:"fil",finnish:"fi",french:"fr",german:"de",greek:"el",hebrew:"he",hindi:"hi",hungarian:"hu",indonesian:"id",italian:"it",japanese:"ja",korean:"ko",latvian:"lv",lithuanian:"lt",malay:"ms",norwegian:"no",polish:"pl",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"sr",slovak:"sk",slovenian:"sl",spanish:"es",swedish:"sv",thai:"th",turkish:"tr",ukrainian:"uk",vietnamese:"vi"};class q extends H{static detector=null;static translators={};constructor(){super("BrowserTranslate")}_isAPIAvailable(){return typeof globalThis>"u"?!1:typeof globalThis.Translator<"u"&&typeof globalThis.LanguageDetector<"u"}_isSpecificTextJsonFormat(t){return Array.isArray(t)&&t.length>0&&t.every(a=>typeof a=="object"&&a!==null&&typeof a.text=="string")}_getLangCode(t){if(!t||typeof t!="string")return"en";if(t===te)return d(`[${this.providerName}] WARNING: AUTO_DETECT_VALUE reached _getLangCode - this should be handled earlier`),"en";const a=t.toLowerCase();return Zt[a]||a}async _detectLanguageForSwapping(t,a){let r=null;if(typeof globalThis.LanguageDetector<"u")try{q.detector||(q.detector=await globalThis.LanguageDetector.create());const i=await q.detector.detect(t);i&&i.length>0&&i[0].confidence>.5&&(r=i[0].detectedLanguage)}catch(i){d(`[${this.providerName}] LanguageDetector failed for swapping, trying Browser.i18n fallback:`,i)}if(!r)try{d(`[${this.providerName}] Trying Browser.i18n.detectLanguage for swapping...`);const i=await F.i18n.detectLanguage(t);if(d(`[${this.providerName}] Browser.i18n.detectLanguage swapping result:`,i),i?.languages&&i.languages.length>0){r=i.languages[0].language.split("-")[0];const e=i.languages[0].percentage||0;d(`[${this.providerName}] Detected language for swapping: ${r} (${e}% confidence, reliable: ${i.isReliable})`)}}catch(i){d(`[${this.providerName}] Browser.i18n.detectLanguage failed for swapping:`,i)}return r}async _applyLanguageSwapping(t,a,r){try{const i=await this._detectLanguageForSwapping(t,r);if(i){const e=this._getLangCode(r);if(i===e)return d(`[${this.providerName}] Languages swapped: ${i} â†’ ${e}`),[r,a]}else{const e=this._getLangCode(r);if(J(t)&&e==="fa")return d(`[${this.providerName}] Languages swapped using regex fallback`),[r,a]}}catch(i){d(`[${this.providerName}] Language detection for swapping failed:`,i);const e=this._getLangCode(r);if(J(t)&&e==="fa")return[r,a]}return[a,r]}async _detectLanguage(t,a){if(a!==te)return this._getLangCode(a);try{if(typeof globalThis.LanguageDetector<"u"){q.detector||(q.detector=await globalThis.LanguageDetector.create());const r=await q.detector.detect(t);if(r&&r.length>0&&r[0].confidence>.5)return d(`[${this.providerName}] Language detected using LanguageDetector: ${r[0].detectedLanguage}`),r[0].detectedLanguage}}catch(r){d(`[${this.providerName}] LanguageDetector failed (${r.message}), falling back to Browser.i18n.detectLanguage`)}try{d(`[${this.providerName}] Trying Browser.i18n.detectLanguage with text: "${t.substring(0,50)}..."`);const r=await F.i18n.detectLanguage(t);if(d(`[${this.providerName}] Browser.i18n.detectLanguage result:`,r),r?.languages&&r.languages.length>0){const i=r.languages[0].language.split("-")[0],e=r.languages[0].percentage||0;return d(`[${this.providerName}] Language detected using Browser.i18n.detectLanguage: ${i} (${e}% confidence, reliable: ${r.isReliable})`),i}else d(`[${this.providerName}] Browser.i18n.detectLanguage result empty`)}catch(r){d(`[${this.providerName}] Browser.i18n.detectLanguage failed:`,r)}return d(`[${this.providerName}] Using regex fallback for language detection`),J(t)?"fa":"en"}async _getTranslator(t,a){const r=`${t}-${a}`;if(q.translators[r])return q.translators[r];if(await globalThis.Translator.availability({sourceLanguage:t,targetLanguage:a})==="unavailable"){const c=new Error(`Translation not available for ${t} to ${a}`);throw c.type=s.LANGUAGE_PAIR_NOT_SUPPORTED,c.context=`${this.providerName.toLowerCase()}-availability`,c}const e=this.providerName,l=await globalThis.Translator.create({sourceLanguage:t,targetLanguage:a,monitor(c){c.addEventListener("downloadprogress",g=>{const A=Math.floor(g.loaded*100);d(`[${e}] Language pack download: ${A}%`)})}});return q.translators[r]=l,l}async translate(t,a,r,i=null){if(!this._isAPIAvailable()){const m=new Error("Chrome Translation API not available. Requires Chrome 138+");throw m.type=s.API,m.context=`${this.providerName.toLowerCase()}-api-unavailable`,m}if(this._isSameLanguage(a,r))return null;[a,r]=await this._applyLanguageSwapping(t,a,r),i===V.Field&&(a=te),i===V.Subtitle&&(a=te);let e,l;if(a===te)try{e=await this._detectLanguage(t,a)}catch(m){d(`[${this.providerName}] Language detection error:`,m),e="en"}else e=this._getLangCode(a);if(l=this._getLangCode(r),e===l&&([e,l]=[l,e]),e===l)return t;let c=!1,g,A=[t];try{const m=JSON.parse(t);this._isSpecificTextJsonFormat(m)&&(c=!0,g=m,A=g.map(n=>n.text))}catch{}try{const m=await this._getTranslator(e,l);let n;if(c){n=[];for(const f of A){const u=await m.translate(f);n.push(u)}}else{const f=A.join(et);n=[await m.translate(f)]}if(c){if(n.length!==g.length)return d(`[${this.providerName}] JSON reconstruction failed due to segment mismatch.`),n.join(" ");const f=g.map((u,C)=>({...u,text:n[C]?.trim()||""}));return JSON.stringify(f,null,2)}else{if(A.length>1){const f=n[0].split(et);if(f.length===A.length)return f.join("")}return n[0]}}catch(m){throw m.message?.includes("Translation not available")?(m.type=s.LANGUAGE_PAIR_NOT_SUPPORTED,m.context=`${this.providerName.toLowerCase()}-language-unavailable`):m.message?.includes("insufficient")?(m.type=s.API,m.context=`${this.providerName.toLowerCase()}-insufficient-resources`):(m.type=s.API,m.context=`${this.providerName.toLowerCase()}-translation-error`),d(`[${this.providerName}] Translation error:`,m),m}}static cleanup(){if(this.detector){try{this.detector.destroy()}catch(t){d("[BrowserTranslate] Error destroying detector:",t)}this.detector=null}for(const t in this.translators)if(this.translators[t]){try{this.translators[t].destroy()}catch(a){d(`[BrowserTranslate] Error destroying translator ${t}:`,a)}delete this.translators[t]}}resetSessionContext(){q.cleanup()}}class ea{constructor(){this.providerInstances=new Map}getProvider(t){if(this.providerInstances.has(t))return this.providerInstances.get(t);let a;switch(t.toLowerCase()){case"google":a=new Bt;break;case"bing":a=new X;break;case"yandex":a=new Ne;break;case"gemini":a=new zt;break;case"openai":a=new Ht;break;case"openrouter":a=new jt;break;case"deepseek":a=new Yt;break;case"webai":a=new Jt;break;case"custom":a=new Qt;break;case"browserapi":a=new q;break;default:{const r=new Error(`Unsupported translation API type: ${t}`);throw r.type=s.API,r.context="translation-provider-factory",r}}return this.providerInstances.set(t,a),a}getSupportedProviders(){return["google","bing","yandex","gemini","openai","openrouter","deepseek","webai","custom","browserapi"]}isProviderSupported(t){return this.getSupportedProviders().includes(t.toLowerCase())}resetProviders(t=null){t?this.providerInstances.delete(t):this.providerInstances.clear()}resetSessionContext(t=null){if(t&&this.providerInstances.has(t))this.providerInstances.get(t).resetSessionContext();else for(const a of this.providerInstances.values())a.resetSessionContext()}}const ae=new ea;class ta{constructor(){this.handlers=new Map,this.setupHandlers()}setupHandlers(){this.handlers.set("TRANSLATE_TEXT",this.handleTranslation.bind(this)),this.handlers.set("TRANSLATE_IMAGE",this.handleImageTranslation.bind(this)),this.handlers.set("GET_PROVIDER_STATUS",this.handleProviderStatus.bind(this)),this.handlers.set("TEST_PROVIDER_CONNECTION",this.handleTestProvider.bind(this)),this.handlers.set("SAVE_PROVIDER_CONFIG",this.handleSaveProviderConfig.bind(this)),this.handlers.set("GET_PROVIDER_CONFIG",this.handleGetProviderConfig.bind(this)),this.handlers.set("START_SCREEN_CAPTURE",this.handleStartScreenCapture.bind(this)),this.handlers.set("CAPTURE_SCREEN_AREA",this.handleCaptureScreenArea.bind(this)),this.handlers.set("UPDATE_CONTEXT_MENU",this.handleUpdateContextMenu.bind(this)),this.handlers.set("GET_EXTENSION_INFO",this.handleGetExtensionInfo.bind(this))}async handleMessage(t,a){const{action:r,data:i}=t;if(t.source!=="vue-app")return null;const e=this.handlers.get(r);if(!e)return{success:!1,error:`Unknown action: ${r}`};try{return{success:!0,data:await e(i,a)}}catch(l){return console.error(`Vue message handler error for ${r}:`,l),{success:!1,error:l.message||"Unknown error",type:l.type||s.UNKNOWN}}}async handleTranslation(t){const{text:a,from:r="auto",to:i="en",provider:e="google",mode:l="simple"}=t;if(!a?.trim())throw new Error("Text to translate cannot be empty");try{return{text:await ae.getProvider(e).translate(a,r,i,l),sourceText:a,fromLanguage:r,toLanguage:i,provider:e,mode:l,timestamp:Date.now()}}catch(c){throw console.error("Translation error:",c),new Error(`Translation failed: ${c.message}`)}}async handleImageTranslation(t){const{imageData:a,from:r="auto",to:i="en",provider:e="gemini",mode:l="simple"}=t;if(!a)throw new Error("Image data cannot be empty");try{const c=ae.getProvider(e);if(typeof c.translateImage!="function")throw new Error(`Provider ${e} does not support image translation`);return{text:await c.translateImage(a,r,i,l),sourceText:"[Image]",fromLanguage:r,toLanguage:i,provider:e,mode:l,timestamp:Date.now(),isImageTranslation:!0}}catch(c){throw console.error("Image translation error:",c),new Error(`Image translation failed: ${c.message}`)}}async handleProviderStatus(t){const{provider:a}=t;try{if(!ae.isProviderSupported(a))return{status:"unsupported",message:`Provider ${a} is not supported`};const r=ae.getProvider(a);if(["gemini","openai","openrouter","deepseek","custom"].includes(a)){const e=await this.getStoredProviderConfig(a);if(!e||!e.apiKey)return{status:"unconfigured",message:"API key required"}}return{status:"ready",message:"Provider is ready",provider:a}}catch(r){return{status:"error",message:r.message}}}async handleTestProvider(t){const{provider:a,config:r}=t;try{const i=ae.getProvider(a);return r&&r.apiKey,{success:!0,message:"Connection successful",testResult:await i.translate("Hello","en","es","simple")}}catch(i){return{success:!1,message:i.message||"Connection failed"}}}async handleSaveProviderConfig(t){const{provider:a,apiKey:r,customUrl:i,model:e}=t;try{const l={apiKey:r,customUrl:i,model:e,timestamp:Date.now()};return await this.storeProviderConfig(a,l),{success:!0,message:"Configuration saved"}}catch(l){throw new Error(`Failed to save configuration: ${l.message}`)}}async handleGetProviderConfig(t){const{provider:a}=t;try{return{config:await this.getStoredProviderConfig(a)||{}}}catch(r){throw new Error(`Failed to get configuration: ${r.message}`)}}async handleStartScreenCapture(t,a){try{const[r]=await browser.tabs.query({active:!0,currentWindow:!0});if(!r)throw new Error("No active tab found");return await browser.tabs.sendMessage(r.id,{action:"START_SCREEN_CAPTURE",source:"background"}),{success:!0,message:"Screen capture started"}}catch(r){throw new Error(`Failed to start screen capture: ${r.message}`)}}async handleCaptureScreenArea(t){const{coordinates:a}=t;try{return{imageData:await browser.tabs.captureVisibleTab({format:"png"}),coordinates:a,timestamp:Date.now()}}catch(r){throw new Error(`Failed to capture screen area: ${r.message}`)}}async handleUpdateContextMenu(t){const{menuItems:a}=t;try{if(await browser.contextMenus.removeAll(),a&&Array.isArray(a))for(const r of a)await browser.contextMenus.create(r);return{success:!0,message:"Context menu updated"}}catch(r){throw new Error(`Failed to update context menu: ${r.message}`)}}async handleGetExtensionInfo(){try{const t=browser.runtime.getManifest();return{name:t.name,version:t.version,description:t.description,permissions:t.permissions||[],id:browser.runtime.id}}catch(t){throw new Error(`Failed to get extension info: ${t.message}`)}}async storeProviderConfig(t,a){const r=`provider_config_${t}`;await browser.storage.local.set({[r]:a})}async getStoredProviderConfig(t){const a=`provider_config_${t}`;return(await browser.storage.local.get(a))[a]||null}register(){browser.runtime.onMessage.addListener(async(t,a,r)=>{if(t.source==="vue-app")return await this.handleMessage(t,a)})}}new ta().register(),console.log("Background script loaded via Vue build system"),console.log("Vue message handler registered")})();
